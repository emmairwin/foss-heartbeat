{"original_position": 37, "diff_hunk": "@@ -17,9 +19,32 @@ Cu.importGlobalProperties([\"URL\"]); /* globals URL */\n \n this.EXPORTED_SYMBOLS = [\"Heartbeat\"];\n \n-const log = LogManager.getLogger(\"heartbeat\");\n const PREF_SURVEY_DURATION = \"browser.uitour.surveyDuration\";\n const NOTIFICATION_TIME = 3000;\n+const HEARTBEAT_CSS_URI = Services.io.newURI(\"resource://shield-recipe-client/skin/shared/Heartbeat.css\");\n+const HEARTBEAT_CSS_URI_OSX = Services.io.newURI(\"resource://shield-recipe-client/skin/osx/Heartbeat.css\");\n+\n+const log = LogManager.getLogger(\"heartbeat\");\n+const windowsWithInjectedCss = new WeakSet();\n+let anyWindowsWithInjectedCss = false;\n+\n+// Add cleanup handler for CSS injected into windows by Heartbeat\n+CleanupManager.addCleanupHandler(() => {\n+  if (anyWindowsWithInjectedCss) {\n+    const windowEnumerator = Services.wm.getEnumerator('navigator:browser');\n+    while (windowEnumerator.hasMoreElements()) {\n+      const window = windowEnumerator.getNext();\n+      if (windowsWithInjectedCss.has(window)) {\n+        const utils = window.QueryInterface(Ci.nsIInterfaceRequestor).getInterface(Ci.nsIDOMWindowUtils);\n+        utils.removeSheet(HEARTBEAT_CSS_URI, window.AGENT_SHEET);\n+        if (AppConstants.platform === 'macosx') {\n+          utils.removeSheet(HEARTBEAT_CSS_URI, window.AGENT_SHEET);", "body_text": "CSS_URI_OSX ?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/770", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/117605756", "created_at": "2017-05-20T09:09:30Z", "author_association": "CONTRIBUTOR", "body": "CSS_URI_OSX ?", "updated_at": "2017-06-12T17:33:37Z", "html_url": "https://github.com/mozilla/normandy/pull/770#discussion_r117605756", "pull_request_review_id": 39331672, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/117605756"}, "html": {"href": "https://github.com/mozilla/normandy/pull/770#discussion_r117605756"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/770"}}, "commit_id": "9e4f925414de43a057dc69bd308e1cdb3f796099", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": null, "path": "recipe-client-addon/lib/Heartbeat.jsm", "body_html": "<p>CSS_URI_OSX ?</p>", "original_commit_id": "1a52e7a6a514189bc278b52444fb2f5213139627", "id": 117605756}