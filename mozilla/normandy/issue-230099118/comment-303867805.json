{"body": "> or testing this, I think we can launch a few new windows, and check window.document.styleSheets to see if the Heartbeat CSS is present, then trigger a Heartbeat on that window and check again.\r\n\r\nI tried writing this test, and it didn't work. Mossop tells me that `window.document.styleSheets` wouldn't be expected to have the style sheet when we load it this way. Because this is easy to test manually, I don't think I'm going to spend any more time on this.\r\n\r\n@Osmose do you want to change you review now?\r\n\r\nHere's the test I tried.\r\n\r\n```js\r\n// Testing CSS injection\r\nadd_task(async () => {\r\n  const targetWindow = await BrowserTestUtils.openNewBrowserWindow();\r\n  const bystanderWindow = await BrowserTestUtils.openNewBrowserWindow();\r\n\r\n  function windowHasHeartbeatCSS(window) {\r\n    for (const styleSheet of window.document.styleSheets) {\r\n      if (styleSheet.href === 'resource://shield-recipe-client/skin/shared/Heartbeat.css') {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  Assert.ok(!windowHasHeartbeatCSS(targetWindow), \"Windows start without heartbeat CSS\");\r\n  Assert.ok(!windowHasHeartbeatCSS(bystanderWindow), \"Windows start without heartbeat CSS\");\r\n\r\n  const hb = new Heartbeat(targetWindow, sandboxManager, {\r\n    testing: true,\r\n    flowId: \"test\",\r\n    message: \"test\",\r\n  });\r\n\r\n  Assert.ok(windowHasHeartbeatCSS(targetWindow), \"Heartbeat CSS gets added to window\");\r\n  Assert.ok(!windowHasHeartbeatCSS(bystanderWindow), \"Heartbeat CSS does not get added to unrelated windows\");\r\n});\r\n```", "body_text": "or testing this, I think we can launch a few new windows, and check window.document.styleSheets to see if the Heartbeat CSS is present, then trigger a Heartbeat on that window and check again.\n\nI tried writing this test, and it didn't work. Mossop tells me that window.document.styleSheets wouldn't be expected to have the style sheet when we load it this way. Because this is easy to test manually, I don't think I'm going to spend any more time on this.\n@Osmose do you want to change you review now?\nHere's the test I tried.\n// Testing CSS injection\nadd_task(async () => {\n  const targetWindow = await BrowserTestUtils.openNewBrowserWindow();\n  const bystanderWindow = await BrowserTestUtils.openNewBrowserWindow();\n\n  function windowHasHeartbeatCSS(window) {\n    for (const styleSheet of window.document.styleSheets) {\n      if (styleSheet.href === 'resource://shield-recipe-client/skin/shared/Heartbeat.css') {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  Assert.ok(!windowHasHeartbeatCSS(targetWindow), \"Windows start without heartbeat CSS\");\n  Assert.ok(!windowHasHeartbeatCSS(bystanderWindow), \"Windows start without heartbeat CSS\");\n\n  const hb = new Heartbeat(targetWindow, sandboxManager, {\n    testing: true,\n    flowId: \"test\",\n    message: \"test\",\n  });\n\n  Assert.ok(windowHasHeartbeatCSS(targetWindow), \"Heartbeat CSS gets added to window\");\n  Assert.ok(!windowHasHeartbeatCSS(bystanderWindow), \"Heartbeat CSS does not get added to unrelated windows\");\n});", "url": "https://api.github.com/repos/mozilla/normandy/issues/comments/303867805", "created_at": "2017-05-24T22:17:31Z", "author_association": "MEMBER", "html_url": "https://github.com/mozilla/normandy/pull/770#issuecomment-303867805", "updated_at": "2017-05-24T22:17:31Z", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "body_html": "<blockquote>\n<p>or testing this, I think we can launch a few new windows, and check window.document.styleSheets to see if the Heartbeat CSS is present, then trigger a Heartbeat on that window and check again.</p>\n</blockquote>\n<p>I tried writing this test, and it didn't work. Mossop tells me that <code>window.document.styleSheets</code> wouldn't be expected to have the style sheet when we load it this way. Because this is easy to test manually, I don't think I'm going to spend any more time on this.</p>\n<p><a class=\"user-mention\" href=\"https://github.com/osmose\">@Osmose</a> do you want to change you review now?</p>\n<p>Here's the test I tried.</p>\n<div class=\"highlight highlight-source-js\"><pre><span class=\"pl-c\"><span class=\"pl-c\">//</span> Testing CSS injection</span>\n<span class=\"pl-en\">add_task</span>(<span class=\"pl-k\">async</span> () <span class=\"pl-k\">=&gt;</span> {\n  <span class=\"pl-k\">const</span> <span class=\"pl-c1\">targetWindow</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">await</span> <span class=\"pl-smi\">BrowserTestUtils</span>.<span class=\"pl-en\">openNewBrowserWindow</span>();\n  <span class=\"pl-k\">const</span> <span class=\"pl-c1\">bystanderWindow</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">await</span> <span class=\"pl-smi\">BrowserTestUtils</span>.<span class=\"pl-en\">openNewBrowserWindow</span>();\n\n  <span class=\"pl-k\">function</span> <span class=\"pl-en\">windowHasHeartbeatCSS</span>(<span class=\"pl-c1\">window</span>) {\n    <span class=\"pl-k\">for</span> (<span class=\"pl-k\">const</span> <span class=\"pl-c1\">styleSheet</span> <span class=\"pl-k\">of</span> <span class=\"pl-c1\">window</span>.<span class=\"pl-smi\">document</span>.<span class=\"pl-c1\">styleSheets</span>) {\n      <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">styleSheet</span>.<span class=\"pl-c1\">href</span> <span class=\"pl-k\">===</span> <span class=\"pl-s\"><span class=\"pl-pds\">'</span>resource://shield-recipe-client/skin/shared/Heartbeat.css<span class=\"pl-pds\">'</span></span>) {\n        <span class=\"pl-k\">return</span> <span class=\"pl-c1\">true</span>;\n      }\n    }\n    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>;\n  }\n\n  <span class=\"pl-smi\">Assert</span>.<span class=\"pl-en\">ok</span>(<span class=\"pl-k\">!</span><span class=\"pl-en\">windowHasHeartbeatCSS</span>(targetWindow), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Windows start without heartbeat CSS<span class=\"pl-pds\">\"</span></span>);\n  <span class=\"pl-smi\">Assert</span>.<span class=\"pl-en\">ok</span>(<span class=\"pl-k\">!</span><span class=\"pl-en\">windowHasHeartbeatCSS</span>(bystanderWindow), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Windows start without heartbeat CSS<span class=\"pl-pds\">\"</span></span>);\n\n  <span class=\"pl-k\">const</span> <span class=\"pl-c1\">hb</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-en\">Heartbeat</span>(targetWindow, sandboxManager, {\n    testing<span class=\"pl-k\">:</span> <span class=\"pl-c1\">true</span>,\n    flowId<span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>test<span class=\"pl-pds\">\"</span></span>,\n    message<span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>test<span class=\"pl-pds\">\"</span></span>,\n  });\n\n  <span class=\"pl-smi\">Assert</span>.<span class=\"pl-en\">ok</span>(<span class=\"pl-en\">windowHasHeartbeatCSS</span>(targetWindow), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Heartbeat CSS gets added to window<span class=\"pl-pds\">\"</span></span>);\n  <span class=\"pl-smi\">Assert</span>.<span class=\"pl-en\">ok</span>(<span class=\"pl-k\">!</span><span class=\"pl-en\">windowHasHeartbeatCSS</span>(bystanderWindow), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Heartbeat CSS does not get added to unrelated windows<span class=\"pl-pds\">\"</span></span>);\n});</pre></div>", "id": 303867805, "issue_url": "https://api.github.com/repos/mozilla/normandy/issues/770"}