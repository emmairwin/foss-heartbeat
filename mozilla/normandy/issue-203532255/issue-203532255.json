{"body_text": "Since the monorepo merge, the Docker build process for recipe-server no longer has access to the git repo to calculate the commit and tag name. We need this information to deploy.\nThe problem is these two lines from Dockerfile:\ngit rev-parse HEAD > __version__/commit && \\\ngit describe --tags --exact-match > __version__/tag || true # may fail if not on a tag\n\nSince the .git directory is at the root of the monorepo, which is not part of the Docker context, these commands fail.\nIt may be ok to fix this only in CI by modifying the CI build scripts. We don't need the version info in non-CI built images, as far as I know.", "labels": [], "number": 455, "assignee": null, "repository_url": "https://api.github.com/repos/mozilla/normandy", "closed_at": "2017-01-31T20:16:34Z", "body_html": "<p>Since the monorepo merge, the Docker build process for recipe-server no longer has access to the git repo to calculate the commit and tag name. We need this information to deploy.</p>\n<p>The problem is these two lines from <code>Dockerfile</code>:</p>\n<pre><code>git rev-parse HEAD &gt; __version__/commit &amp;&amp; \\\ngit describe --tags --exact-match &gt; __version__/tag || true # may fail if not on a tag\n</code></pre>\n<p>Since the <code>.git</code> directory is at the root of the monorepo, which is not part of the Docker context, these commands fail.</p>\n<p>It may be ok to fix this only in CI by modifying the CI build scripts. We don't need the version info in non-CI built images, as far as I know.</p>", "id": 203532255, "title": "Fix commit info in recipe-server Docker  image", "comments": 2, "state": "closed", "body": "Since the monorepo merge, the Docker build process for recipe-server no longer has access to the git repo to calculate the commit and tag name. We need this information to deploy.\r\n\r\nThe problem is these two lines from `Dockerfile`:\r\n\r\n```\r\ngit rev-parse HEAD > __version__/commit && \\\r\ngit describe --tags --exact-match > __version__/tag || true # may fail if not on a tag\r\n```\r\n\r\nSince the `.git` directory is at the root of the monorepo, which is not part of the Docker context, these commands fail.\r\n\r\nIt may be ok to fix this only in CI by modifying the CI build scripts. We don't need the version info in non-CI built images, as far as I know.", "events_url": "https://api.github.com/repos/mozilla/normandy/issues/455/events", "labels_url": "https://api.github.com/repos/mozilla/normandy/issues/455/labels{/name}", "author_association": "MEMBER", "comments_url": "https://api.github.com/repos/mozilla/normandy/issues/455/comments", "html_url": "https://github.com/mozilla/normandy/issues/455", "updated_at": "2017-01-31T20:16:34Z", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "milestone": null, "locked": false, "url": "https://api.github.com/repos/mozilla/normandy/issues/455", "created_at": "2017-01-27T00:46:43Z", "assignees": []}