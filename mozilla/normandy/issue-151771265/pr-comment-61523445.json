{"original_position": 46, "diff_hunk": "@@ -208,20 +208,47 @@ def test_matches_deals_with_none(self):\n \n \n class TestClient(object):\n-    @pytest.mark.parametrize('x_forwarded_for,expected_ip', [\n-        ('192.0.2.0,127.0.0.1', '192.0.2.0'),\n-        ('192.0.2.0', '192.0.2.0'),\n-    ])\n-    def test_country_x_forwarded_for(self, rf, x_forwarded_for, expected_ip):\n-        client = Client(rf.get('/', HTTP_X_FORWARDED_FOR=x_forwarded_for))\n+    def test_country_remote_addr_fallback(self, rf):\n+        client = Client(rf.get('/', REMOTE_ADDR='192.0.2.0'))\n \n         with patch('normandy.recipes.models.get_country_code') as get_country_code:\n             assert client.country == get_country_code.return_value\n-            get_country_code.assert_called_with(expected_ip)\n+            get_country_code.assert_called_with('192.0.2.0')\n \n-    def test_country_remote_addr_fallback(self, rf):\n-        client = Client(rf.get('/', REMOTE_ADDR='192.0.2.0'))\n+    def test_x_forwarded_for_no_proxies(self, rf, settings):\n+        \"\"\"If there are no proxies, REMOTE_ADDR should be used.\"\"\"\n+        settings.NUM_PROXIES = 0\n+        client_ip = '1.1.1.1'\n+        req = rf.get('/', HTTP_X_FORWARDED_FOR='fake', REMOTE_ADDR=client_ip)\n+        client = Client(req)\n \n         with patch('normandy.recipes.models.get_country_code') as get_country_code:\n             assert client.country == get_country_code.return_value\n-            get_country_code.assert_called_with('192.0.2.0')\n+            get_country_code.assert_called_with(client_ip)\n+\n+    def test_x_forwarded_for_one_proxy(self, rf, settings):\n+        \"\"\"If there is one proxy, the right-most value in HTTP_X_FORWARDED_FOR should be used.\"\"\"\n+        settings.NUM_PROXIES = 1\n+        client_ip = '1.1.1.1'\n+        nginx_ip = '2.2.2.2'\n+        forwarded_for = ', '.join(['fake', client_ip])\n+        req = rf.get('/', HTTP_X_FORWARDED_FOR=forwarded_for, REMOTE_ADDR=nginx_ip)\n+        client = Client(req)\n+\n+        with patch('normandy.recipes.models.get_country_code') as get_country_code:\n+            assert client.country == get_country_code.return_value\n+            get_country_code.assert_called_with(client_ip)\n+\n+    def test_x_forwarded_for_two_proxies(self, rf, settings):\n+        \"\"\"If there is one proxy, the right-most value in HTTP_X_FORWARDED_FOR should be used.\"\"\"", "body_text": "You forgot to update this docstring.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/126", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/61523445", "created_at": "2016-04-29T00:31:11Z", "author_association": "MEMBER", "body": "You forgot to update this docstring.\n", "updated_at": "2016-04-29T17:12:05Z", "html_url": "https://github.com/mozilla/normandy/pull/126#discussion_r61523445", "pull_request_review_id": null, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/61523445"}, "html": {"href": "https://github.com/mozilla/normandy/pull/126#discussion_r61523445"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/126"}}, "commit_id": "70c9f905e3e9ee855c40a665f685d1424b1b6c55", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": null, "path": "normandy/recipes/tests/test_models.py", "body_html": "<p>You forgot to update this docstring.</p>", "original_commit_id": "30a1003b058e95e0fb2005a3491646fb27b454c5", "id": 61523445}