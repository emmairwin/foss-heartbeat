{"original_position": 67, "diff_hunk": "@@ -356,22 +358,80 @@ decorate_task(\n   }\n );\n \n+// Test init() first run\n decorate_task(\n   withPrefEnv({\n     set: [\n       [\"extensions.shield-recipe-client.dev_mode\", false],\n       [\"extensions.shield-recipe-client.first_run\", true],\n+      [\"extensions.shield-recipe-client.api_url\", \"https://example.com\"],\n     ],\n   }),\n   withStub(RecipeRunner, \"run\"),\n   withStub(RecipeRunner, \"registerTimer\"),\n-  async function testInitFirstRun(runStub, registerTimerStub) {\n+  withStub(RecipeRunner, \"watchPrefs\"),\n+  async function testInitFirstRun(runStub, registerTimerStub, watchPrefsStub) {\n     await RecipeRunner.init();\n     ok(runStub.called, \"RecipeRunner.run is called immediately on first run\");\n     ok(\n       !Services.prefs.getBoolPref(\"extensions.shield-recipe-client.first_run\"),\n       \"On first run, the first run pref is set to false\"\n     );\n     ok(registerTimerStub.called, \"RecipeRunner.registerTimer registers a timer\");\n+\n+    // RecipeRunner.init() sets this to false, but SpecialPowers\n+    // relies on the preferences it manages to actually change when it\n+    // tries to change them. Settings this back to true here allows\n+    // that to happen. Not doing this causes popPrefEnv to hang forever.\n+    Services.prefs.setBoolPref(\"extensions.shield-recipe-client.first_run\", true);\n+  }\n+);\n+\n+// Test that prefs are watched correctly\n+decorate_task(\n+  withPrefEnv({\n+    set: [\n+      [\"toolkit.telemetry.unified\", true],  // telemetry enabled\n+      [\"extensions.shield-recipe-client.dev_mode\", false],\n+      [\"extensions.shield-recipe-client.first_run\", false],\n+      [\"extensions.shield-recipe-client.enabled\", true],\n+      [\"extensions.shield-recipe-client.api_url\", \"https://example.com\"], // starts with \"https://\"\n+    ],\n+  }),\n+  withStub(RecipeRunner, \"run\"),\n+  withStub(RecipeRunner, \"enable\"),\n+  withStub(RecipeRunner, \"disable\"),\n+  withStub(CleanupManager, \"addCleanupHandler\"),\n+\n+  async function testPrefWatching(runStub, enableStub, disableStub, addCleanupHandlerStub) {\n+    await RecipeRunner.init();", "body_text": "Since enable is stubbed out, and the watchers are set through that, no. I think we're ok here.", "in_reply_to_id": 142555889, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1080", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/142811379", "created_at": "2017-10-04T22:38:30Z", "author_association": "MEMBER", "body": "Since `enable` is stubbed out, and the watchers are set through that, no. I think we're ok here.", "updated_at": "2017-10-17T23:40:17Z", "html_url": "https://github.com/mozilla/normandy/pull/1080#discussion_r142811379", "pull_request_review_id": 67228235, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/142811379"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1080#discussion_r142811379"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1080"}}, "commit_id": "256f439bd54cc922e7ccf6f536b1c271191953a7", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": 67, "path": "recipe-client-addon/test/browser/browser_RecipeRunner.js", "body_html": "<p>Since <code>enable</code> is stubbed out, and the watchers are set through that, no. I think we're ok here.</p>", "original_commit_id": "cb52c6f500dbe6a01a5bee8dc1af3e7b753ab7d7", "id": 142811379}