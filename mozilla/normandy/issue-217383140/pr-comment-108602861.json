{"original_position": 45, "diff_hunk": "@@ -23,22 +24,33 @@ this.EXPORTED_SYMBOLS = [\"RecipeRunner\"];\n \n const log = LogManager.getLogger(\"recipe-runner\");\n const prefs = Services.prefs.getBranch(\"extensions.shield-recipe-client.\");\n+const TIMER_NAME = \"recipe-client-addon-run\";\n \n this.RecipeRunner = {\n   init() {\n     if (!this.checkPrefs()) {\n       return;\n     }\n \n-    let delay;\n     if (prefs.getBoolPref(\"dev_mode\")) {\n-      delay = 0;\n-    } else {\n-      // startup delay is in seconds\n-      delay = prefs.getIntPref(\"startup_delay_seconds\") * 1000;\n+      // Run right now in dev mode\n+      this.run();\n     }\n \n-    setTimeout(this.start.bind(this), delay);\n+    // Run once every `runInterval` wall-clock seconds.\n+    // This is managed by setting a \"last ran\" timestamp, and running if it is\n+    // more than `runInterval` seconds ago.\n+    const runInterval = prefs.getIntPref(\"run_interval_seconds\");\n+    const timerManager = Cc[\"@mozilla.org/updates/timer-manager;1\"]\n+                         .getService(Ci.nsIUpdateTimerManager);", "body_text": "Much like how it was recommended we lazy-load modules when possible, we should probably do this for services too. It looks like XPCOMUtils.defineLazyServiceGetter can do this for us.\nAlso, can this be in the import section instead of within this function?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/641", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/108602861", "created_at": "2017-03-29T06:57:54Z", "author_association": "MEMBER", "body": "Much like how it was recommended we lazy-load modules when possible, we should probably do this for services too. It looks like [`XPCOMUtils.defineLazyServiceGetter`](https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/XPCOMUtils.jsm#defineLazyServiceGetter()) can do this for us. \r\n\r\nAlso, can this be in the import section instead of within this function?", "updated_at": "2017-04-12T17:14:33Z", "html_url": "https://github.com/mozilla/normandy/pull/641#discussion_r108602861", "pull_request_review_id": 29642972, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/108602861"}, "html": {"href": "https://github.com/mozilla/normandy/pull/641#discussion_r108602861"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/641"}}, "commit_id": "03a7b3e238d9a956b4deb74246b94e438e3fb490", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": null, "path": "recipe-client-addon/lib/RecipeRunner.jsm", "body_html": "<p>Much like how it was recommended we lazy-load modules when possible, we should probably do this for services too. It looks like <a href=\"https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/XPCOMUtils.jsm#defineLazyServiceGetter()\" rel=\"nofollow\"><code>XPCOMUtils.defineLazyServiceGetter</code></a> can do this for us.</p>\n<p>Also, can this be in the import section instead of within this function?</p>", "original_commit_id": "cf59e849a7982781219464618875539fd6644fc3", "id": 108602861}