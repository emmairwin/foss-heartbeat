{"original_position": 79, "diff_hunk": "@@ -32,23 +31,73 @@ class LocalStorage {\n }\n \n /**\n+ * EventEmitter for Heartbeat events. Unlike normal event emitters,\n+ * Heartbeat events only occur once, and we guarantee that if a handler\n+ * is registered _after_ an event occurs, it will still be executed.\n+ */\n+class HeartbeatEmitter {\n+  static EVENTS = [\n+    'NotificationOffered',\n+    'NotificationClosed',\n+    'LearnMore',\n+    'Voted',\n+    'TelemetrySent',\n+    'Engaged',\n+  ]\n+\n+  constructor() {\n+    this.callbacks = {};\n+    this.eventData = {};\n+    for (const event of HeartbeatEmitter.EVENTS) {\n+      this.callbacks[event] = [];\n+      this.eventData[event] = null;\n+    }\n+  }\n+\n+  on(eventName, callback) {\n+    if (HeartbeatEmitter.EVENTS.indexOf(eventName) === -1) {\n+      throw new Error(`${eventName} is an invalid Heartbeat event type.`);\n+    }\n+\n+    this.callbacks[eventName].push(callback);\n+\n+    // Call the callback if the event already happened.\n+    const data = this.eventData[eventName];\n+    if (data !== null) {\n+      callback(data);\n+    }\n+  }\n+\n+  emit(eventName, data) {\n+    if (this.eventData[eventName] !== null) {\n+      throw new Error(`Cannot emit a Heartbeat event more than once: ${eventName}`);\n+    }\n+\n+    this.eventData[eventName] = data;\n+    for (const callback of this.callbacks[eventName]) {\n+      callback(data);\n+    }\n+  }\n+}\n+\n+/**\n  * Implementation of the Normandy driver.\n  */\n export default class NormandyDriver {\n   constructor(uitour = Mozilla.UITour) {\n     this._uitour = uitour;\n   }\n \n-  _heartbeatCallbacks = [];\n+  _heartbeatCallbacks = {};\n   registerCallbacks() {\n     // Trigger heartbeat callbacks when the UITour tells us that Heartbeat\n     // happened.\n     this._uitour.observe((eventName, data) => {\n       if (eventName.startsWith('Heartbeat:')) {\n-        const flowId = data.flowId;\n         const croppedEventName = eventName.slice(10); // Chop off \"Heartbeat:\"\n-        if (flowId in this._heartbeatCallbacks) {\n-          this._heartbeatCallbacks[flowId](croppedEventName, data);\n+        const callback = this._heartbeatCallbacks[data.flowId];\n+        if (callback !== undefined) {\n+          callback(croppedEventName, data);", "body_text": "This is just fixing _heartbeatCallbacks to be an object instead of an array, because it is used as an object, not an array, right? There aren't any behavioral changes?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/296", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/83934930", "created_at": "2016-10-18T19:44:51Z", "author_association": "MEMBER", "body": "This is just fixing `_heartbeatCallbacks` to be an object instead of an array, because it is used as an object, not an array, right? There aren't any behavioral changes?\n", "updated_at": "2016-10-19T23:36:35Z", "html_url": "https://github.com/mozilla/normandy/pull/296#discussion_r83934930", "pull_request_review_id": 4745623, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/83934930"}, "html": {"href": "https://github.com/mozilla/normandy/pull/296#discussion_r83934930"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/296"}}, "commit_id": "751e7a5987a6133cd2ac9a49ec21a61cd78ee828", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": 79, "path": "client/selfrepair/normandy_driver.js", "body_html": "<p>This is just fixing <code>_heartbeatCallbacks</code> to be an object instead of an array, because it is used as an object, not an array, right? There aren't any behavioral changes?</p>", "original_commit_id": "0c8316a12b1b7e92cbc6c50686bb3a7edb1eefd4", "id": 83934930}