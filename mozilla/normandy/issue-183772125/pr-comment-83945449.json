{"original_position": 79, "diff_hunk": "@@ -32,23 +31,73 @@ class LocalStorage {\n }\n \n /**\n+ * EventEmitter for Heartbeat events. Unlike normal event emitters,\n+ * Heartbeat events only occur once, and we guarantee that if a handler\n+ * is registered _after_ an event occurs, it will still be executed.\n+ */\n+class HeartbeatEmitter {\n+  static EVENTS = [\n+    'NotificationOffered',\n+    'NotificationClosed',\n+    'LearnMore',\n+    'Voted',\n+    'TelemetrySent',\n+    'Engaged',\n+  ]\n+\n+  constructor() {\n+    this.callbacks = {};\n+    this.eventData = {};\n+    for (const event of HeartbeatEmitter.EVENTS) {\n+      this.callbacks[event] = [];\n+      this.eventData[event] = null;\n+    }\n+  }\n+\n+  on(eventName, callback) {\n+    if (HeartbeatEmitter.EVENTS.indexOf(eventName) === -1) {\n+      throw new Error(`${eventName} is an invalid Heartbeat event type.`);\n+    }\n+\n+    this.callbacks[eventName].push(callback);\n+\n+    // Call the callback if the event already happened.\n+    const data = this.eventData[eventName];\n+    if (data !== null) {\n+      callback(data);\n+    }\n+  }\n+\n+  emit(eventName, data) {\n+    if (this.eventData[eventName] !== null) {\n+      throw new Error(`Cannot emit a Heartbeat event more than once: ${eventName}`);\n+    }\n+\n+    this.eventData[eventName] = data;\n+    for (const callback of this.callbacks[eventName]) {\n+      callback(data);\n+    }\n+  }\n+}\n+\n+/**\n  * Implementation of the Normandy driver.\n  */\n export default class NormandyDriver {\n   constructor(uitour = Mozilla.UITour) {\n     this._uitour = uitour;\n   }\n \n-  _heartbeatCallbacks = [];\n+  _heartbeatCallbacks = {};\n   registerCallbacks() {\n     // Trigger heartbeat callbacks when the UITour tells us that Heartbeat\n     // happened.\n     this._uitour.observe((eventName, data) => {\n       if (eventName.startsWith('Heartbeat:')) {\n-        const flowId = data.flowId;\n         const croppedEventName = eventName.slice(10); // Chop off \"Heartbeat:\"\n-        if (flowId in this._heartbeatCallbacks) {\n-          this._heartbeatCallbacks[flowId](croppedEventName, data);\n+        const callback = this._heartbeatCallbacks[data.flowId];\n+        if (callback !== undefined) {\n+          callback(croppedEventName, data);", "body_text": "Aha, yeah. I forgot that I packed like four bugs into one fix here.\nSo it was declared an array but used as an object. So we make it an object. Also, below, we were using heartbeatCallbacks instead of _heartbeatCallbacks, so the UITour events weren't even triggering properly at all.\nIt's honestly a bit embarrassing.", "in_reply_to_id": 83934930, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/296", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/83945449", "created_at": "2016-10-18T20:38:58Z", "author_association": "MEMBER", "body": "Aha, yeah. I forgot that I packed like four bugs into one fix here.\n\nSo it was declared an array but used as an object. So we make it an object. Also, below, we were using `heartbeatCallbacks` instead of `_heartbeatCallbacks`, so the UITour events weren't even triggering properly at all.\n\nIt's honestly a bit embarrassing.\n", "updated_at": "2016-10-19T23:36:35Z", "html_url": "https://github.com/mozilla/normandy/pull/296#discussion_r83945449", "pull_request_review_id": 4755712, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/83945449"}, "html": {"href": "https://github.com/mozilla/normandy/pull/296#discussion_r83945449"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/296"}}, "commit_id": "751e7a5987a6133cd2ac9a49ec21a61cd78ee828", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": 79, "path": "client/selfrepair/normandy_driver.js", "body_html": "<p>Aha, yeah. I forgot that I packed like four bugs into one fix here.</p>\n<p>So it was declared an array but used as an object. So we make it an object. Also, below, we were using <code>heartbeatCallbacks</code> instead of <code>_heartbeatCallbacks</code>, so the UITour events weren't even triggering properly at all.</p>\n<p>It's honestly a bit embarrassing.</p>", "original_commit_id": "0c8316a12b1b7e92cbc6c50686bb3a7edb1eefd4", "id": 83945449}