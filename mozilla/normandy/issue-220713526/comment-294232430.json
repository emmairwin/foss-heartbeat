{"body": "> @Osmose can you take a look at 9837a97 and tell me if something's missing? The start test isn't receiving the preferenceType property I've added, but I'm not sure why. Thoughts?\r\n\r\nThe test that you added is actually working fine. When I run the tests locally, I see the error:\r\n\r\n```\r\n 0:01.58 LOG: Thread-9 ERROR Unexpected exception Error: Previous preference value is of type \"32\", but was given \"0\" (undefined) at resource://shield-recipe-client/lib/PreferenceExperiments.jsm:217\r\nstart@resource://shield-recipe-client/lib/PreferenceExperiments.jsm:217:15\r\nasync*@/Users/mkelly/Projects/mozilla-unified/obj-x86_64-apple-darwin16.4.0/_tests/xpcshell/browser/extensions/shield-recipe-client/test/unit/test_PreferenceExperiments.js:88:9\r\nasync*inner@utils.js:15:35\r\nasync*inner@resource://shield-recipe-client/lib/PreferenceExperiments.jsm:131:37\r\nasync*asyncFunction@resource://gre/modules/Task.jsm:241:18\r\nTask_spawn@resource://gre/modules/Task.jsm:166:12\r\n_run_next_test@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:1554:9\r\nrun@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:703:9\r\n_do_main@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:211:5\r\n_execute_test@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:546:5\r\n@-e:1:1\r\n```\r\n\r\nNote the `test_PreferenceExperiments.jsm` line; it says line 88 is where it failed, which isn't inside the new test you added. It's in another test for `start`, which is not passing the new `preferenceType` parameter. You'll have to update the existing tests to pass the new parameter as well as adding a new test.\r\n\r\nAlso, there's a bug in `PreferenceExperiments.jsm` in that commit, on line 212 you're indexing into the `typeConversions` object using `givenType`, when the index should be `argumentValueType`.\r\n\r\nAlso, we just recently found out that the tests in `test_PreferenceExperiments.jsm` are broken because `PreferenceExperiments.jsm` now relies on Telemetry, which isn't compatible with xpcshell tests. Even if you fix these issues, your test runs should fail. @mythmon is, as we speak, working on a patch to convert the test suite to mochitests. In the meantime, if you can get the code working in a manual test, I can do a code review, until the test fix is done.", "body_text": "@Osmose can you take a look at 9837a97 and tell me if something's missing? The start test isn't receiving the preferenceType property I've added, but I'm not sure why. Thoughts?\n\nThe test that you added is actually working fine. When I run the tests locally, I see the error:\n 0:01.58 LOG: Thread-9 ERROR Unexpected exception Error: Previous preference value is of type \"32\", but was given \"0\" (undefined) at resource://shield-recipe-client/lib/PreferenceExperiments.jsm:217\nstart@resource://shield-recipe-client/lib/PreferenceExperiments.jsm:217:15\nasync*@/Users/mkelly/Projects/mozilla-unified/obj-x86_64-apple-darwin16.4.0/_tests/xpcshell/browser/extensions/shield-recipe-client/test/unit/test_PreferenceExperiments.js:88:9\nasync*inner@utils.js:15:35\nasync*inner@resource://shield-recipe-client/lib/PreferenceExperiments.jsm:131:37\nasync*asyncFunction@resource://gre/modules/Task.jsm:241:18\nTask_spawn@resource://gre/modules/Task.jsm:166:12\n_run_next_test@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:1554:9\nrun@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:703:9\n_do_main@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:211:5\n_execute_test@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:546:5\n@-e:1:1\n\nNote the test_PreferenceExperiments.jsm line; it says line 88 is where it failed, which isn't inside the new test you added. It's in another test for start, which is not passing the new preferenceType parameter. You'll have to update the existing tests to pass the new parameter as well as adding a new test.\nAlso, there's a bug in PreferenceExperiments.jsm in that commit, on line 212 you're indexing into the typeConversions object using givenType, when the index should be argumentValueType.\nAlso, we just recently found out that the tests in test_PreferenceExperiments.jsm are broken because PreferenceExperiments.jsm now relies on Telemetry, which isn't compatible with xpcshell tests. Even if you fix these issues, your test runs should fail. @mythmon is, as we speak, working on a patch to convert the test suite to mochitests. In the meantime, if you can get the code working in a manual test, I can do a code review, until the test fix is done.", "url": "https://api.github.com/repos/mozilla/normandy/issues/comments/294232430", "created_at": "2017-04-14T20:40:33Z", "author_association": "MEMBER", "html_url": "https://github.com/mozilla/normandy/pull/673#issuecomment-294232430", "updated_at": "2017-04-14T20:40:33Z", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "body_html": "<blockquote>\n<p><a class=\"user-mention\" href=\"https://github.com/osmose\">@Osmose</a> can you take a look at <a class=\"commit-link\" href=\"https://github.com/mozilla/normandy/commit/9837a97541206066534a4595f7020230fcf32aed\"><tt>9837a97</tt></a> and tell me if something's missing? The start test isn't receiving the preferenceType property I've added, but I'm not sure why. Thoughts?</p>\n</blockquote>\n<p>The test that you added is actually working fine. When I run the tests locally, I see the error:</p>\n<pre><code> 0:01.58 LOG: Thread-9 ERROR Unexpected exception Error: Previous preference value is of type \"32\", but was given \"0\" (undefined) at resource://shield-recipe-client/lib/PreferenceExperiments.jsm:217\nstart@resource://shield-recipe-client/lib/PreferenceExperiments.jsm:217:15\nasync*@/Users/mkelly/Projects/mozilla-unified/obj-x86_64-apple-darwin16.4.0/_tests/xpcshell/browser/extensions/shield-recipe-client/test/unit/test_PreferenceExperiments.js:88:9\nasync*inner@utils.js:15:35\nasync*inner@resource://shield-recipe-client/lib/PreferenceExperiments.jsm:131:37\nasync*asyncFunction@resource://gre/modules/Task.jsm:241:18\nTask_spawn@resource://gre/modules/Task.jsm:166:12\n_run_next_test@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:1554:9\nrun@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:703:9\n_do_main@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:211:5\n_execute_test@/Users/mkelly/Projects/mozilla-unified/testing/xpcshell/head.js:546:5\n@-e:1:1\n</code></pre>\n<p>Note the <code>test_PreferenceExperiments.jsm</code> line; it says line 88 is where it failed, which isn't inside the new test you added. It's in another test for <code>start</code>, which is not passing the new <code>preferenceType</code> parameter. You'll have to update the existing tests to pass the new parameter as well as adding a new test.</p>\n<p>Also, there's a bug in <code>PreferenceExperiments.jsm</code> in that commit, on line 212 you're indexing into the <code>typeConversions</code> object using <code>givenType</code>, when the index should be <code>argumentValueType</code>.</p>\n<p>Also, we just recently found out that the tests in <code>test_PreferenceExperiments.jsm</code> are broken because <code>PreferenceExperiments.jsm</code> now relies on Telemetry, which isn't compatible with xpcshell tests. Even if you fix these issues, your test runs should fail. <a class=\"user-mention\" href=\"https://github.com/mythmon\">@mythmon</a> is, as we speak, working on a patch to convert the test suite to mochitests. In the meantime, if you can get the code working in a manual test, I can do a code review, until the test fix is done.</p>", "id": 294232430, "issue_url": "https://api.github.com/repos/mozilla/normandy/issues/673"}