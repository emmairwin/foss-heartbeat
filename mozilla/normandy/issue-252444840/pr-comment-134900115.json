{"original_position": 52, "diff_hunk": "@@ -56,11 +65,31 @@ this.ShieldPreferences = {\n           this.injectOptOutStudyCheckbox(subject.document);\n         }\n         break;\n-      // If the FHR pref changes, set the opt-out-study pref to the value it is changing to.\n       case NS_PREFBRANCH_PREFCHANGE_TOPIC_ID:\n-        if (data === FHR_UPLOAD_ENABLED_PREF) {\n-          const fhrUploadEnabled = Services.prefs.getBoolPref(FHR_UPLOAD_ENABLED_PREF);\n-          Services.prefs.setBoolPref(OPT_OUT_STUDIES_ENABLED_PREF, fhrUploadEnabled);\n+        this.observePrefChange(data);\n+        break;\n+    }\n+  },\n+\n+  async observePrefChange(prefName) {\n+    let prefValue;\n+    switch (prefName) {\n+      // If the FHR pref changes, set the opt-out-study pref to the value it is changing to.\n+      case FHR_UPLOAD_ENABLED_PREF:\n+        prefValue = Services.prefs.getBoolPref(FHR_UPLOAD_ENABLED_PREF);\n+        Services.prefs.setBoolPref(OPT_OUT_STUDIES_ENABLED_PREF, prefValue);\n+        break;\n+\n+      // If the opt-out pref changes to be false, disable all current studies.\n+      case OPT_OUT_STUDIES_ENABLED_PREF:\n+        prefValue = Services.prefs.getBoolPref(OPT_OUT_STUDIES_ENABLED_PREF);\n+        if (!prefValue) {\n+          for (const study of await AddonStudies.getAll()) {\n+            if (study.active) {\n+              dump(`\\nSTOPPING ${study.recipeId}\\n`);", "body_text": "Oops", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1002", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/134900115", "created_at": "2017-08-24T00:02:07Z", "author_association": "MEMBER", "body": "Oops", "updated_at": "2017-08-25T17:18:53Z", "html_url": "https://github.com/mozilla/normandy/pull/1002#discussion_r134900115", "pull_request_review_id": 58248013, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/134900115"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1002#discussion_r134900115"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1002"}}, "commit_id": "0bf3bac097c3f2b0929a2bbb185258e6f2018e48", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": null, "path": "recipe-client-addon/lib/ShieldPreferences.jsm", "body_html": "<p>Oops</p>", "original_commit_id": "27f2204019309b4ceed592351731c7d11d88105d", "id": 134900115}