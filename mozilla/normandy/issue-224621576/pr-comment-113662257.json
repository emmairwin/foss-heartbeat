{"original_position": 99, "diff_hunk": "@@ -4,95 +4,27 @@\n \"use strict\";\n \n const {utils: Cu} = Components;\n-Cu.import(\"resource://gre/modules/Services.jsm\");\n-Cu.import(\"resource://gre/modules/Preferences.jsm\");\n-Cu.import(\"resource://gre/modules/Log.jsm\");\n Cu.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n \n XPCOMUtils.defineLazyModuleGetter(this, \"LogManager\",\n   \"resource://shield-recipe-client/lib/LogManager.jsm\");\n-XPCOMUtils.defineLazyModuleGetter(this, \"RecipeRunner\",\n-  \"resource://shield-recipe-client/lib/RecipeRunner.jsm\");\n-XPCOMUtils.defineLazyModuleGetter(this, \"CleanupManager\",\n-  \"resource://shield-recipe-client/lib/CleanupManager.jsm\");\n-XPCOMUtils.defineLazyModuleGetter(this, \"PreferenceExperiments\",\n-  \"resource://shield-recipe-client/lib/PreferenceExperiments.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"ShieldRecipeClient\",\n+  \"resource://shield-recipe-client/lib/ShieldRecipeClient.jsm\");\n \n-const REASONS = {\n-  APP_STARTUP: 1,      // The application is starting up.\n-  APP_SHUTDOWN: 2,     // The application is shutting down.\n-  ADDON_ENABLE: 3,     // The add-on is being enabled.\n-  ADDON_DISABLE: 4,    // The add-on is being disabled. (Also sent during uninstallation)\n-  ADDON_INSTALL: 5,    // The add-on is being installed.\n-  ADDON_UNINSTALL: 6,  // The add-on is being uninstalled.\n-  ADDON_UPGRADE: 7,    // The add-on is being upgraded.\n-  ADDON_DOWNGRADE: 8,  // The add-on is being downgraded.\n-};\n-\n-const PREF_BRANCH = \"extensions.shield-recipe-client.\";\n-const DEFAULT_PREFS = {\n-  api_url: \"https://normandy.cdn.mozilla.net/api/v1\",\n-  dev_mode: false,\n-  enabled: true,\n-  startup_delay_seconds: 300,\n-  \"logging.level\": Log.Level.Warn,\n-  user_id: \"\",\n-  run_interval_seconds: 86400, // 24 hours\n-};\n-const PREF_DEV_MODE = \"extensions.shield-recipe-client.dev_mode\";\n-const PREF_SELF_SUPPORT_ENABLED = \"browser.selfsupport.enabled\";\n-const PREF_LOGGING_LEVEL = PREF_BRANCH + \"logging.level\";\n-\n-let shouldRun = true;\n-let log = null;\n-\n-// These are exported for testing purposes only.\n-this.EXPORTED_SYMBOLS = [\"install\", \"startup\", \"shutdown\", \"uninstall\"];\n-\n-this.install = function() {\n-  // Self Repair only checks its pref on start, so if we disable it, wait until\n-  // next startup to run, unless the dev_mode preference is set.\n-  if (Preferences.get(PREF_SELF_SUPPORT_ENABLED, true)) {\n-    Preferences.set(PREF_SELF_SUPPORT_ENABLED, false);\n-    if (!Preferences.get(PREF_DEV_MODE, false)) {\n-      shouldRun = false;\n-    }\n-  }\n-};\n+this.install = function() {};\n \n this.startup = async function() {\n-  setDefaultPrefs();\n-\n-  // Setup logging and listen for changes to logging prefs\n-  LogManager.configure(Services.prefs.getIntPref(PREF_LOGGING_LEVEL));\n-  log = LogManager.getLogger(\"bootstrap\");\n-  Preferences.observe(PREF_LOGGING_LEVEL, LogManager.configure);\n-  CleanupManager.addCleanupHandler(\n-    () => Preferences.ignore(PREF_LOGGING_LEVEL, LogManager.configure));\n-\n-  if (!shouldRun) {\n-    return;\n-  }\n-\n-  // Initialize experiments first to avoid a race between initializing prefs\n-  // and recipes rolling back pref changes when experiments end.\n-  try {\n-    await PreferenceExperiments.init();\n-  } catch (err) {\n-    log.error(\"Failed to initialize preference experiments:\", err);\n-  }\n-\n-  await RecipeRunner.init();\n+  await ShieldRecipeClient.startup();\n };\n \n this.shutdown = function(data, reason) {\n-  CleanupManager.cleanup();\n-\n-  if (reason === REASONS.ADDON_DISABLE || reason === REASONS.ADDON_UNINSTALL) {\n-    Services.prefs.setBoolPref(PREF_SELF_SUPPORT_ENABLED, true);\n-  }\n+  ShieldRecipeClient.shutdown(reason);\n \n+  // Unload add-on modules. We don't do this in ShieldRecipeClient so that\n+  // modules are not unloaded accidentally during tests.\n+  const log = LogManager.getLogger(\"bootstrap\");", "body_text": "We may or may not have called LogManager.configure() here, per https://bugzilla.mozilla.org/show_bug.cgi?id=1351465#c5 . I don't know if that should be a serious concern, but I wanted to flag this up.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/721", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/113662257", "created_at": "2017-04-27T10:19:31Z", "author_association": "CONTRIBUTOR", "body": "We may or may not have called LogManager.configure() here, per https://bugzilla.mozilla.org/show_bug.cgi?id=1351465#c5 . I don't know if that should be a serious concern, but I wanted to flag this up.", "updated_at": "2017-04-27T16:03:45Z", "html_url": "https://github.com/mozilla/normandy/pull/721#discussion_r113662257", "pull_request_review_id": 35068889, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/113662257"}, "html": {"href": "https://github.com/mozilla/normandy/pull/721#discussion_r113662257"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/721"}}, "commit_id": "8b123720643a26e571c3cef94a91ab0609eb43a6", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": 99, "path": "recipe-client-addon/bootstrap.js", "body_html": "<p>We may or may not have called LogManager.configure() here, per <a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=1351465#c5\" rel=\"nofollow\">https://bugzilla.mozilla.org/show_bug.cgi?id=1351465#c5</a> . I don't know if that should be a serious concern, but I wanted to flag this up.</p>", "original_commit_id": "044f14988b240e8a8efda5ec26ea7765bbdb7c34", "id": 113662257}