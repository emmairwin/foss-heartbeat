{"original_position": 63, "diff_hunk": "@@ -31,38 +25,35 @@ export default class PreferenceExperimentAction extends Action {\n     // Exit early if we're on an incompatible client.\n     if (experiments === undefined) {\n       this.normandy.log('Client does not support preference experiments, aborting.', 'info');\n-      return Promise.resolve();\n+      return;\n     }\n \n     seenExperimentNames.push(slug);\n-    return experiments.has(slug).then(hasSlug => {\n-      // If the experiment doesn't exist yet, enroll!\n-      if (!hasSlug) {\n-        return this.chooseBranch(branches).then(branch =>\n-          experiments.start({\n-            name: slug,\n-            branch: branch.slug,\n-            preferenceName,\n-            preferenceValue: branch.value,\n-            preferenceBranchType,\n-            preferenceType,\n-          })\n-        );\n-      }\n-\n-      // If the experiment exists, and isn't expired, bump the lastSeen date.\n-      return experiments.get(slug).then(experiment => {\n-        if (experiment.expired) {\n-          this.normandy.log(`Experiment ${slug} has expired, aborting.`, 'debug');\n-          return true;\n-        }\n \n-        return experiments.markLastSeen(slug);\n+    // If the experiment doesn't exist yet, enroll!\n+    const hasSlug = await experiments.has(slug);\n+    if (!hasSlug) {\n+      const branch = await this.chooseBranch(branches);\n+      await experiments.start({\n+        name: slug,\n+        branch: branch.slug,\n+        preferenceName,\n+        preferenceValue: branch.value,\n+        preferenceBranchType,\n+        preferenceType,\n       });\n-    });\n+    } else {\n+      // If the experiment exists, and isn't expired, bump the lastSeen date.\n+      const experiment = await experiments.get(slug);\n+      if (experiment.expired) {", "body_text": "I'm personally not a fan of !(await whatever()), if anything I'd break that into its own variable before the conditional statement, e.g.:\nconst ok = await whatever();\nif (!ok) { ... }\n\nIn general, I agree with your thoughts on breaking actions into standalone functions. I think a lot of it can be determined case-by-case, and this is a small piece that it may not be necessary to refactor - what's there is fine for me. If you want to replace it with the alternative, that makes sense to me, too.", "in_reply_to_id": 123260914, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/822", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/124346290", "created_at": "2017-06-27T17:44:45Z", "author_association": "CONTRIBUTOR", "body": "I'm personally not a fan of `!(await whatever())`, if anything I'd break that into its own variable before the conditional statement, e.g.:\r\n\r\n```\r\nconst ok = await whatever();\r\nif (!ok) { ... }\r\n```\r\nIn general, I agree with your thoughts on breaking actions into standalone functions. I think a lot of it can be determined case-by-case, and this is a small piece that it may not be necessary to refactor - what's there is fine for me. If you want to replace it with the alternative, that makes sense to me, too.", "updated_at": "2017-06-27T17:44:45Z", "html_url": "https://github.com/mozilla/normandy/pull/822#discussion_r124346290", "pull_request_review_id": 46626852, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/124346290"}, "html": {"href": "https://github.com/mozilla/normandy/pull/822#discussion_r124346290"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/822"}}, "commit_id": "514c9308346f8b28ab2ae59db2d9ab6810487d3e", "user": {"following_url": "https://api.github.com/users/andymikulski/following{/other_user}", "events_url": "https://api.github.com/users/andymikulski/events{/privacy}", "organizations_url": "https://api.github.com/users/andymikulski/orgs", "url": "https://api.github.com/users/andymikulski", "gists_url": "https://api.github.com/users/andymikulski/gists{/gist_id}", "html_url": "https://github.com/andymikulski", "subscriptions_url": "https://api.github.com/users/andymikulski/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/2767162?v=4", "repos_url": "https://api.github.com/users/andymikulski/repos", "received_events_url": "https://api.github.com/users/andymikulski/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/andymikulski/starred{/owner}{/repo}", "site_admin": false, "login": "andymikulski", "type": "User", "id": 2767162, "followers_url": "https://api.github.com/users/andymikulski/followers"}, "position": 73, "path": "recipe-server/client/actions/preference-experiment/index.js", "body_html": "<p>I'm personally not a fan of <code>!(await whatever())</code>, if anything I'd break that into its own variable before the conditional statement, e.g.:</p>\n<pre><code>const ok = await whatever();\nif (!ok) { ... }\n</code></pre>\n<p>In general, I agree with your thoughts on breaking actions into standalone functions. I think a lot of it can be determined case-by-case, and this is a small piece that it may not be necessary to refactor - what's there is fine for me. If you want to replace it with the alternative, that makes sense to me, too.</p>", "original_commit_id": "e2276bef4d1a6dd0d44d1d5a01f65fc3cbb282e4", "id": 124346290}