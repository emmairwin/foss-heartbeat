{"deletions": 256, "merge_commit_sha": "64242f341db8bb3ab85ba1af4365eb146cd8d5cb", "additions": 509, "labels": [], "number": 557, "assignee": null, "mergeable": null, "closed_at": "2017-03-02T21:02:18Z", "requested_reviewers": [], "statuses_url": "https://api.github.com/repos/mozilla/normandy/statuses/24ca379ceb8b510786c0d6ffaa3af4e707f5d2a0", "id": 108035595, "maintainer_can_modify": false, "title": "Add missing filter expression context to add-on.", "body_text": "So #539 and #540 only point out two of them, but the add-on is missing a significant amount of client environment info in the filter expression context. Luckily all of them are already implemented in the driver, so I just had to steal them from there.\nWhen I started on this, I couldn't figure out where I wanted to add all this new data to the filter expression context, which led to the first three commits, which refactor things so that:\n\nFilterExpressions.jsm (formerly EnvExpressions.jsm) doesn't provide any default context, and only cares about evaluating expressions. Well, okay, there's still the filter functions, but we can handle that in another PR.\nThe logic for figuring out info about the client environment is separated into the ClientEnvironment.jsm file.\n\nThe last commit actually adds the missing info to the filter expression context. I tried to add tests for most of them, but I'm stumped on how to mock some of them (like plugins). Others (like the appinfo stuff) don't seem to have a meaningful test. I'm pretty sure this PR still net-increases our test coverage, but suggestions on this are welcome.\nOne potential side effect of this PR is that it makes it so that clients don't hit the classify-client endpoint if there aren't any recipes enabled that use country or request_time filters. Which means a single database change can have a huge effect on our traffic. @relud: Are large swings in traffic to the classify endpoint something we specifically want to avoid? I can change this to consistently hit the server even if we're not using the data from it.", "comments": 4, "merged_at": "2017-03-02T21:02:18Z", "state": "closed", "_links": {"review_comment": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments{/number}"}, "commits": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/557/commits"}, "self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/557"}, "review_comments": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/557/comments"}, "html": {"href": "https://github.com/mozilla/normandy/pull/557"}, "comments": {"href": "https://api.github.com/repos/mozilla/normandy/issues/557/comments"}, "issue": {"href": "https://api.github.com/repos/mozilla/normandy/issues/557"}, "statuses": {"href": "https://api.github.com/repos/mozilla/normandy/statuses/24ca379ceb8b510786c0d6ffaa3af4e707f5d2a0"}}, "changed_files": 24, "diff_url": "https://github.com/mozilla/normandy/pull/557.diff", "issue_url": "https://api.github.com/repos/mozilla/normandy/issues/557", "body": "So #539 and #540 only point out two of them, but the add-on is missing a significant amount of client environment info in the filter expression context. Luckily all of them are already implemented in the driver, so I just had to steal them from there.\r\n\r\nWhen I started on this, I couldn't figure out where I wanted to add all this new data to the filter expression context, which led to the first three commits, which refactor things so that:\r\n\r\n- `FilterExpressions.jsm` (formerly `EnvExpressions.jsm`) doesn't provide any default context, and only cares about evaluating expressions. Well, okay, there's still the filter functions, but we can handle that in another PR.\r\n- The logic for figuring out info about the client environment is separated into the `ClientEnvironment.jsm` file.\r\n\r\nThe last commit actually adds the missing info to the filter expression context. I tried to add tests for most of them, but I'm stumped on how to mock some of them (like plugins). Others (like the appinfo stuff) don't seem to have a meaningful test. I'm pretty sure this PR still net-increases our test coverage, but suggestions on this are welcome.\r\n\r\nOne potential side effect of this PR is that it makes it so that clients don't hit the classify-client endpoint if there aren't any recipes enabled that use country or request_time filters. Which means a single database change can have a huge effect on our traffic. @relud: Are large swings in traffic to the classify endpoint something we specifically want to avoid? I can change this to consistently hit the server even if we're not using the data from it.", "head": {"repo": {"issues_url": "https://api.github.com/repos/Osmose/normandy/issues{/number}", "deployments_url": "https://api.github.com/repos/Osmose/normandy/deployments", "stargazers_count": 0, "forks_url": "https://api.github.com/repos/Osmose/normandy/forks", "mirror_url": null, "subscription_url": "https://api.github.com/repos/Osmose/normandy/subscription", "notifications_url": "https://api.github.com/repos/Osmose/normandy/notifications{?since,all,participating}", "collaborators_url": "https://api.github.com/repos/Osmose/normandy/collaborators{/collaborator}", "updated_at": "2017-01-07T01:53:48Z", "private": false, "pulls_url": "https://api.github.com/repos/Osmose/normandy/pulls{/number}", "issue_comment_url": "https://api.github.com/repos/Osmose/normandy/issues/comments{/number}", "labels_url": "https://api.github.com/repos/Osmose/normandy/labels{/name}", "has_wiki": true, "full_name": "Osmose/normandy", "owner": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "statuses_url": "https://api.github.com/repos/Osmose/normandy/statuses/{sha}", "id": 48456654, "keys_url": "https://api.github.com/repos/Osmose/normandy/keys{/key_id}", "description": "Self-Repair 2", "tags_url": "https://api.github.com/repos/Osmose/normandy/tags", "archived": false, "downloads_url": "https://api.github.com/repos/Osmose/normandy/downloads", "assignees_url": "https://api.github.com/repos/Osmose/normandy/assignees{/user}", "contents_url": "https://api.github.com/repos/Osmose/normandy/contents/{+path}", "has_pages": false, "git_refs_url": "https://api.github.com/repos/Osmose/normandy/git/refs{/sha}", "open_issues_count": 0, "has_projects": true, "clone_url": "https://github.com/Osmose/normandy.git", "watchers_count": 0, "git_tags_url": "https://api.github.com/repos/Osmose/normandy/git/tags{/sha}", "milestones_url": "https://api.github.com/repos/Osmose/normandy/milestones{/number}", "languages_url": "https://api.github.com/repos/Osmose/normandy/languages", "size": 5331, "homepage": null, "fork": true, "commits_url": "https://api.github.com/repos/Osmose/normandy/commits{/sha}", "releases_url": "https://api.github.com/repos/Osmose/normandy/releases{/id}", "issue_events_url": "https://api.github.com/repos/Osmose/normandy/issues/events{/number}", "archive_url": "https://api.github.com/repos/Osmose/normandy/{archive_format}{/ref}", "comments_url": "https://api.github.com/repos/Osmose/normandy/comments{/number}", "events_url": "https://api.github.com/repos/Osmose/normandy/events", "contributors_url": "https://api.github.com/repos/Osmose/normandy/contributors", "html_url": "https://github.com/Osmose/normandy", "forks": 0, "compare_url": "https://api.github.com/repos/Osmose/normandy/compare/{base}...{head}", "open_issues": 0, "watchers": 0, "git_url": "git://github.com/Osmose/normandy.git", "svn_url": "https://github.com/Osmose/normandy", "merges_url": "https://api.github.com/repos/Osmose/normandy/merges", "has_issues": false, "ssh_url": "git@github.com:Osmose/normandy.git", "blobs_url": "https://api.github.com/repos/Osmose/normandy/git/blobs{/sha}", "git_commits_url": "https://api.github.com/repos/Osmose/normandy/git/commits{/sha}", "hooks_url": "https://api.github.com/repos/Osmose/normandy/hooks", "has_downloads": true, "license": null, "name": "normandy", "language": "JavaScript", "url": "https://api.github.com/repos/Osmose/normandy", "created_at": "2015-12-22T22:18:41Z", "pushed_at": "2017-10-04T15:41:24Z", "forks_count": 0, "default_branch": "master", "teams_url": "https://api.github.com/repos/Osmose/normandy/teams", "trees_url": "https://api.github.com/repos/Osmose/normandy/git/trees{/sha}", "branches_url": "https://api.github.com/repos/Osmose/normandy/branches{/branch}", "subscribers_url": "https://api.github.com/repos/Osmose/normandy/subscribers", "stargazers_url": "https://api.github.com/repos/Osmose/normandy/stargazers"}, "sha": "24ca379ceb8b510786c0d6ffaa3af4e707f5d2a0", "ref": "default-browser-filter", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "label": "Osmose:default-browser-filter"}, "commits_url": "https://api.github.com/repos/mozilla/normandy/pulls/557/commits", "commits": 8, "author_association": "MEMBER", "comments_url": "https://api.github.com/repos/mozilla/normandy/issues/557/comments", "html_url": "https://github.com/mozilla/normandy/pull/557", "rebaseable": null, "updated_at": "2017-03-23T17:44:00Z", "base": {"repo": {"issues_url": "https://api.github.com/repos/mozilla/normandy/issues{/number}", "deployments_url": "https://api.github.com/repos/mozilla/normandy/deployments", "stargazers_count": 24, "forks_url": "https://api.github.com/repos/mozilla/normandy/forks", "mirror_url": null, "subscription_url": "https://api.github.com/repos/mozilla/normandy/subscription", "notifications_url": "https://api.github.com/repos/mozilla/normandy/notifications{?since,all,participating}", "collaborators_url": "https://api.github.com/repos/mozilla/normandy/collaborators{/collaborator}", "updated_at": "2018-03-14T22:20:49Z", "private": false, "pulls_url": "https://api.github.com/repos/mozilla/normandy/pulls{/number}", "issue_comment_url": "https://api.github.com/repos/mozilla/normandy/issues/comments{/number}", "labels_url": "https://api.github.com/repos/mozilla/normandy/labels{/name}", "has_wiki": false, "full_name": "mozilla/normandy", "owner": {"following_url": "https://api.github.com/users/mozilla/following{/other_user}", "events_url": "https://api.github.com/users/mozilla/events{/privacy}", "organizations_url": "https://api.github.com/users/mozilla/orgs", "url": "https://api.github.com/users/mozilla", "gists_url": "https://api.github.com/users/mozilla/gists{/gist_id}", "html_url": "https://github.com/mozilla", "subscriptions_url": "https://api.github.com/users/mozilla/subscriptions", "avatar_url": "https://avatars2.githubusercontent.com/u/131524?v=4", "repos_url": "https://api.github.com/users/mozilla/repos", "received_events_url": "https://api.github.com/users/mozilla/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mozilla/starred{/owner}{/repo}", "site_admin": false, "login": "mozilla", "type": "Organization", "id": 131524, "followers_url": "https://api.github.com/users/mozilla/followers"}, "statuses_url": "https://api.github.com/repos/mozilla/normandy/statuses/{sha}", "id": 48456638, "keys_url": "https://api.github.com/repos/mozilla/normandy/keys{/key_id}", "description": "Firefox recipe server", "tags_url": "https://api.github.com/repos/mozilla/normandy/tags", "archived": false, "downloads_url": "https://api.github.com/repos/mozilla/normandy/downloads", "assignees_url": "https://api.github.com/repos/mozilla/normandy/assignees{/user}", "contents_url": "https://api.github.com/repos/mozilla/normandy/contents/{+path}", "has_pages": false, "git_refs_url": "https://api.github.com/repos/mozilla/normandy/git/refs{/sha}", "open_issues_count": 73, "has_projects": true, "clone_url": "https://github.com/mozilla/normandy.git", "watchers_count": 24, "git_tags_url": "https://api.github.com/repos/mozilla/normandy/git/tags{/sha}", "milestones_url": "https://api.github.com/repos/mozilla/normandy/milestones{/number}", "languages_url": "https://api.github.com/repos/mozilla/normandy/languages", "size": 6015, "homepage": "https://wiki.mozilla.org/Firefox/Recipe_Server", "fork": false, "commits_url": "https://api.github.com/repos/mozilla/normandy/commits{/sha}", "releases_url": "https://api.github.com/repos/mozilla/normandy/releases{/id}", "issue_events_url": "https://api.github.com/repos/mozilla/normandy/issues/events{/number}", "archive_url": "https://api.github.com/repos/mozilla/normandy/{archive_format}{/ref}", "comments_url": "https://api.github.com/repos/mozilla/normandy/comments{/number}", "events_url": "https://api.github.com/repos/mozilla/normandy/events", "contributors_url": "https://api.github.com/repos/mozilla/normandy/contributors", "html_url": "https://github.com/mozilla/normandy", "forks": 39, "compare_url": "https://api.github.com/repos/mozilla/normandy/compare/{base}...{head}", "open_issues": 73, "watchers": 24, "git_url": "git://github.com/mozilla/normandy.git", "svn_url": "https://github.com/mozilla/normandy", "merges_url": "https://api.github.com/repos/mozilla/normandy/merges", "has_issues": true, "ssh_url": "git@github.com:mozilla/normandy.git", "blobs_url": "https://api.github.com/repos/mozilla/normandy/git/blobs{/sha}", "git_commits_url": "https://api.github.com/repos/mozilla/normandy/git/commits{/sha}", "hooks_url": "https://api.github.com/repos/mozilla/normandy/hooks", "has_downloads": true, "license": null, "name": "normandy", "language": "Python", "url": "https://api.github.com/repos/mozilla/normandy", "created_at": "2015-12-22T22:18:19Z", "pushed_at": "2018-03-14T22:20:47Z", "forks_count": 39, "default_branch": "master", "teams_url": "https://api.github.com/repos/mozilla/normandy/teams", "trees_url": "https://api.github.com/repos/mozilla/normandy/git/trees{/sha}", "branches_url": "https://api.github.com/repos/mozilla/normandy/branches{/branch}", "subscribers_url": "https://api.github.com/repos/mozilla/normandy/subscribers", "stargazers_url": "https://api.github.com/repos/mozilla/normandy/stargazers"}, "sha": "8863282988d03f24607d35bdcdcdd448ab5e55a4", "ref": "master", "user": {"following_url": "https://api.github.com/users/mozilla/following{/other_user}", "events_url": "https://api.github.com/users/mozilla/events{/privacy}", "organizations_url": "https://api.github.com/users/mozilla/orgs", "url": "https://api.github.com/users/mozilla", "gists_url": "https://api.github.com/users/mozilla/gists{/gist_id}", "html_url": "https://github.com/mozilla", "subscriptions_url": "https://api.github.com/users/mozilla/subscriptions", "avatar_url": "https://avatars2.githubusercontent.com/u/131524?v=4", "repos_url": "https://api.github.com/users/mozilla/repos", "received_events_url": "https://api.github.com/users/mozilla/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mozilla/starred{/owner}{/repo}", "site_admin": false, "login": "mozilla", "type": "Organization", "id": 131524, "followers_url": "https://api.github.com/users/mozilla/followers"}, "label": "mozilla:master"}, "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "milestone": null, "requested_teams": [], "locked": false, "merged_by": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "url": "https://api.github.com/repos/mozilla/normandy/pulls/557", "mergeable_state": "unknown", "created_at": "2017-02-27T02:03:59Z", "merged": true, "review_comments_url": "https://api.github.com/repos/mozilla/normandy/pulls/557/comments", "review_comments": 10, "assignees": [], "review_comment_url": "https://api.github.com/repos/mozilla/normandy/pulls/comments{/number}", "patch_url": "https://github.com/mozilla/normandy/pull/557.patch", "body_html": "<p>So <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"209607081\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/mozilla/normandy/issues/539\" href=\"https://github.com/mozilla/normandy/issues/539\">#539</a> and <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"209607489\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/mozilla/normandy/issues/540\" href=\"https://github.com/mozilla/normandy/issues/540\">#540</a> only point out two of them, but the add-on is missing a significant amount of client environment info in the filter expression context. Luckily all of them are already implemented in the driver, so I just had to steal them from there.</p>\n<p>When I started on this, I couldn't figure out where I wanted to add all this new data to the filter expression context, which led to the first three commits, which refactor things so that:</p>\n<ul>\n<li><code>FilterExpressions.jsm</code> (formerly <code>EnvExpressions.jsm</code>) doesn't provide any default context, and only cares about evaluating expressions. Well, okay, there's still the filter functions, but we can handle that in another PR.</li>\n<li>The logic for figuring out info about the client environment is separated into the <code>ClientEnvironment.jsm</code> file.</li>\n</ul>\n<p>The last commit actually adds the missing info to the filter expression context. I tried to add tests for most of them, but I'm stumped on how to mock some of them (like plugins). Others (like the appinfo stuff) don't seem to have a meaningful test. I'm pretty sure this PR still net-increases our test coverage, but suggestions on this are welcome.</p>\n<p>One potential side effect of this PR is that it makes it so that clients don't hit the classify-client endpoint if there aren't any recipes enabled that use country or request_time filters. Which means a single database change can have a huge effect on our traffic. <a class=\"user-mention\" href=\"https://github.com/relud\">@relud</a>: Are large swings in traffic to the classify endpoint something we specifically want to avoid? I can change this to consistently hit the server even if we're not using the data from it.</p>"}