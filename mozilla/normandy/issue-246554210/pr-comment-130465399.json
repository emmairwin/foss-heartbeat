{"original_position": 74, "diff_hunk": "@@ -112,6 +124,46 @@ this.AddonStudies = {\n     };\n   },\n \n+  async init() {\n+    // If the add-on an active study has been removed since we last ran, stop\n+    // the study.\n+    const activeStudies = (await this.getAll()).filter(study => study.active);\n+    const db = await getDatabase();\n+    for (const study of activeStudies) {\n+      const addon = await AddonManager.getAddonByID(study.addonId);\n+      if (!addon) {\n+        this.markAsEnded(study);\n+        await getStore(db).put(study);\n+        Services.obs.notifyObservers(study, STUDY_ENDED_TOPIC);", "body_text": "I hesitated doing that because I don't want to send the notification out until the save has actually happened. I didn't save inside the method because the add-on watcher needs to use its own database instance to save.\nBut I could pass in the database to use as a parameter to solve that. And it's pretty much an internal-only API anyway, I should just remove it from the exported object.", "in_reply_to_id": 130251700, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/942", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/130465399", "created_at": "2017-07-31T21:21:53Z", "author_association": "MEMBER", "body": "I hesitated doing that because I don't want to send the notification out until the save has actually happened. I didn't save inside the method because the add-on watcher needs to use its own database instance to save.\r\n\r\nBut I could pass in the database to use as a parameter to solve that. And it's pretty much an internal-only API anyway, I should just remove it from the exported object.", "updated_at": "2017-08-03T20:19:01Z", "html_url": "https://github.com/mozilla/normandy/pull/942#discussion_r130465399", "pull_request_review_id": 53344662, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/130465399"}, "html": {"href": "https://github.com/mozilla/normandy/pull/942#discussion_r130465399"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/942"}}, "commit_id": "903d5c551c05f5682b0304557cfbe6bc94229f74", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": null, "path": "recipe-client-addon/lib/AddonStudies.jsm", "body_html": "<p>I hesitated doing that because I don't want to send the notification out until the save has actually happened. I didn't save inside the method because the add-on watcher needs to use its own database instance to save.</p>\n<p>But I could pass in the database to use as a parameter to solve that. And it's pretty much an internal-only API anyway, I should just remove it from the exported object.</p>", "original_commit_id": "3b45b720cf14081c90c3effb147853d12a9b9795", "id": 130465399}