{"original_position": 74, "diff_hunk": "@@ -112,6 +124,46 @@ this.AddonStudies = {\n     };\n   },\n \n+  async init() {\n+    // If the add-on an active study has been removed since we last ran, stop\n+    // the study.\n+    const activeStudies = (await this.getAll()).filter(study => study.active);\n+    const db = await getDatabase();\n+    for (const study of activeStudies) {\n+      const addon = await AddonManager.getAddonByID(study.addonId);\n+      if (!addon) {\n+        this.markAsEnded(study);\n+        await getStore(db).put(study);\n+        Services.obs.notifyObservers(study, STUDY_ENDED_TOPIC);", "body_text": "Can we just do this in markAsEnded directly? Updating the study based on an optional (default to this.db) passed DB connection would also reduce duplication and reduce the risk that we later add some other callsite for markAsEnded that doesn't do this.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/942", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/130251700", "created_at": "2017-07-30T20:20:36Z", "author_association": "CONTRIBUTOR", "body": "Can we just do this in `markAsEnded` directly? Updating the study based on an optional (default to this.db) passed DB connection would also reduce duplication and reduce the risk that we later add some other callsite for markAsEnded that doesn't do this.", "updated_at": "2017-08-03T20:19:01Z", "html_url": "https://github.com/mozilla/normandy/pull/942#discussion_r130251700", "pull_request_review_id": 53105279, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/130251700"}, "html": {"href": "https://github.com/mozilla/normandy/pull/942#discussion_r130251700"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/942"}}, "commit_id": "903d5c551c05f5682b0304557cfbe6bc94229f74", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": null, "path": "recipe-client-addon/lib/AddonStudies.jsm", "body_html": "<p>Can we just do this in <code>markAsEnded</code> directly? Updating the study based on an optional (default to this.db) passed DB connection would also reduce duplication and reduce the risk that we later add some other callsite for markAsEnded that doesn't do this.</p>", "original_commit_id": "3b45b720cf14081c90c3effb147853d12a9b9795", "id": 130251700}