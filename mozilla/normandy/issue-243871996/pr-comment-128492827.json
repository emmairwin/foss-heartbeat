{"original_position": 36, "diff_hunk": "@@ -50,12 +51,26 @@ this.RecipeRunner = {\n       this.run();\n     }\n \n-    this.updateRunInterval();\n-    CleanupManager.addCleanupHandler(() => timerManager.unregisterTimer(TIMER_NAME));\n+    // Run once immediately after the UI is available. Do this before adding the\n+    // timer so we can't end up racing it.\n+    const observer = {\n+      observe: (subject, topic, data) => {\n+        Services.obs.removeObserver(this, UI_AVAILABLE_NOTIFICATION);\n \n-    // Watch for the run interval to change, and re-register the timer with the new value\n-    prefs.addObserver(RUN_INTERVAL_PREF, this);\n-    CleanupManager.addCleanupHandler(() => prefs.removeObserver(RUN_INTERVAL_PREF, this));\n+        this.run();\n+        this.updateRunInterval();\n+        CleanupManager.addCleanupHandler(() => timerManager.unregisterTimer(TIMER_NAME));\n+\n+        // Watch for the run interval to change, and re-register the timer with the new value\n+        prefs.addObserver(RUN_INTERVAL_PREF, this);\n+        CleanupManager.addCleanupHandler(() => prefs.removeObserver(RUN_INTERVAL_PREF, this));\n+      },\n+      QueryInterface: XPCOMUtils.generateQI([\n+        Components.interfaces.nsIObserver,\n+        Components.interfaces.nsISupportsWeakReference,\n+      ]),\n+    };\n+    Services.obs.addObserver(observer, UI_AVAILABLE_NOTIFICATION);", "body_text": "Separately, what happens if we update this add-on out of band and the notification has already happened? Would we just wait forever and never call .run()?\nIf we only want this to happen on first run, as said in the comments, I guess we want a pref of sorts.", "in_reply_to_id": 128492464, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/895", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/128492827", "created_at": "2017-07-20T11:46:59Z", "author_association": "CONTRIBUTOR", "body": "Separately, what happens if we update this add-on out of band and the notification has already happened? Would we just wait forever and never call `.run()`?\r\n\r\nIf we only want this to happen on first run, as said in the comments, I guess we want a pref of sorts.", "updated_at": "2017-07-25T22:42:16Z", "html_url": "https://github.com/mozilla/normandy/pull/895#discussion_r128492827", "pull_request_review_id": 51176289, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/128492827"}, "html": {"href": "https://github.com/mozilla/normandy/pull/895#discussion_r128492827"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/895"}}, "commit_id": "deccb8340392e8e09d93edd04c80950e3c946aef", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": null, "path": "recipe-client-addon/lib/RecipeRunner.jsm", "body_html": "<p>Separately, what happens if we update this add-on out of band and the notification has already happened? Would we just wait forever and never call <code>.run()</code>?</p>\n<p>If we only want this to happen on first run, as said in the comments, I guess we want a pref of sorts.</p>", "original_commit_id": "8ac29d09a56d0daf224336ee765f3b8631446f06", "id": 128492827}