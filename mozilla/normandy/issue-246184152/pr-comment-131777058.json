{"original_position": 119, "diff_hunk": "@@ -145,20 +153,67 @@ this.NormandyApi = {\n \n   /**\n    * Fetch an array of available actions from the server.\n+   * @param filters\n+   * @param filters.enabled {boolean} If true, only returns enabled\n+   * recipes. Default true.\n    * @resolves {Array}\n    */\n-  async fetchActions() {\n-    const actionApiUrl = await this.getApiUrl(\"action-list\");\n-    const res = await this.get(actionApiUrl);\n-    return res.json();\n+  async fetchRecipes(filters = {enabled: true}) {\n+    return this.fetchSignedObjects(\"recipe\", filters);\n+  },\n+\n+  /**\n+   * Fetch an array of available actions from the server.\n+   * @resolves {Array}\n+   */\n+  async fetchActions(filters = {}) {\n+    return this.fetchSignedObjects(\"action\", filters);\n   },\n \n   async fetchImplementation(action) {\n-    const response = await fetch(action.implementation_url);\n-    if (response.ok) {\n-      return response.text();\n+    const implementationUrl = new URL(this.absolutify(action.implementation_url));\n+\n+    // fetch implementation\n+    const response = await fetch(implementationUrl);\n+    if (!response.ok) {\n+      throw new Error(\n+        `Failed to fetch action implementation for ${action.name}: ${response.status}`\n+      );\n+    }\n+    const responseText = await response.text();\n+\n+    // Try to verify integrity of the implementation text.  If the\n+    // integrity value doesn't match the content or uses an unknown\n+    // algorithm, fail.\n+\n+    // Get the last non-empty portion of the url path, and split it\n+    // into two to get the aglorithm and hash.\n+    const parts = implementationUrl.pathname.split(\"/\");\n+    const lastNonEmpty = parts.filter(p => p !== \"\").slice(-1)[0];\n+    const [algorithm, ...hashParts] = lastNonEmpty.split(\"-\");\n+    const expectedHash = hashParts.join(\"-\");\n+\n+    if (algorithm !== \"sha384\") {", "body_text": "As a part of this change, I changed from sha1 to sha384 hashes. Changing the algorithm was rather painful. I'd like to make this extensible so it is easier to change should we need to do it again.", "in_reply_to_id": 131764345, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/934", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/131777058", "created_at": "2017-08-07T22:13:56Z", "author_association": "MEMBER", "body": "As a part of this change, I changed from sha1 to sha384 hashes. Changing the algorithm was rather painful. I'd like to make this extensible so it is easier to change should we need to do it again.", "updated_at": "2017-08-09T17:29:37Z", "html_url": "https://github.com/mozilla/normandy/pull/934#discussion_r131777058", "pull_request_review_id": 54789289, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/131777058"}, "html": {"href": "https://github.com/mozilla/normandy/pull/934#discussion_r131777058"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/934"}}, "commit_id": "9b11c6f569d0e9e3d25e024a14c775e0184ba9b7", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": 119, "path": "recipe-client-addon/lib/NormandyApi.jsm", "body_html": "<p>As a part of this change, I changed from sha1 to sha384 hashes. Changing the algorithm was rather painful. I'd like to make this extensible so it is easier to change should we need to do it again.</p>", "original_commit_id": "276fd5fbb89f000267cede859a3f01dbbaecd9dc", "id": 131777058}