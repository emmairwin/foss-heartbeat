{"body_text": "NOTE: This depends on #641. I don't expect major changes on that PR so this is probably fine for review, but we should wait for that to land before merging this.\nThis should be the last major refactor for preference experiments. The problem is that we want to stop any experiments that weren't reported by the server or matched to the user, as disabling a recipe simply stops sending it to users. But how do we run logic for preference experiments that don't have action code running? Or, if there's no experiments going out, how do run any action code at all?\nMy answer is to add pre-execution and post-execution hooks that run before any recipes are executed, as well as after all of them are. Each action can register a pre- and post-execution hook. These hooks are executed regardless of whether any recipes were run with the action, which covers stopping the last active experiment. And, if the pre-execution hook fails, we skip recipes and post-execution hooks for the action that failed, to avoid running them with potentially-invalid state.\nSince that meant there were now 3 different types of callables being registered inside the sandbox, it made sense to generalize the pattern. I left the old registerAction API in so that we don't immediately have to rewrite our actions.\nThere was also enough logic to prepping the sandbox that I split it into a new ActionSandboxManager class, but I kept the SandboxManager class as a separate base class. In my head, SandboxManager is our general object-oriented wrapper for sandboxes, while ActionSandboxManager is where Normandy-specific sandbox prep goes.\nEach commit is pretty standalone, and the shift-click trick for choosing commits to include in the diff will probably come in handy too. I think the bits not from #641 are ready for review. r?", "labels": [], "number": 659, "assignee": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "repository_url": "https://api.github.com/repos/mozilla/normandy", "closed_at": "2017-04-13T21:12:26Z", "body_html": "<p><strong>NOTE:</strong> This depends on <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"217383140\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/mozilla/normandy/issues/641\" href=\"https://github.com/mozilla/normandy/pull/641\">#641</a>. I don't expect major changes on that PR so this is probably fine for review, but we should wait for that to land before merging this.</p>\n<p>This <em>should</em> be the last major refactor for preference experiments. The problem is that we want to stop any experiments that weren't reported by the server or matched to the user, as disabling a recipe simply stops sending it to users. But how do we run logic for preference experiments that don't have action code running? Or, if there's no experiments going out, how do run any action code at all?</p>\n<p>My answer is to add pre-execution and post-execution hooks that run before any recipes are executed, as well as after all of them are. Each action can register a pre- and post-execution hook. These hooks are executed regardless of whether any recipes were run with the action, which covers stopping the last active experiment. And, if the pre-execution hook fails, we skip recipes and post-execution hooks for the action that failed, to avoid running them with potentially-invalid state.</p>\n<p>Since that meant there were now 3 different types of callables being registered inside the sandbox, it made sense to generalize the pattern. I left the old <code>registerAction</code> API in so that we don't immediately have to rewrite our actions.</p>\n<p>There was also enough logic to prepping the sandbox that I split it into a new <code>ActionSandboxManager</code> class, but I kept the <code>SandboxManager</code> class as a separate base class. In my head, <code>SandboxManager</code> is our general object-oriented wrapper for sandboxes, while <code>ActionSandboxManager</code> is where Normandy-specific sandbox prep goes.</p>\n<p>Each commit is pretty standalone, and the shift-click trick for choosing commits to include in the diff will probably come in handy too. I think the bits not from <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load issue title\" data-id=\"217383140\" data-permission-text=\"Issue title is private\" data-url=\"https://github.com/mozilla/normandy/issues/641\" href=\"https://github.com/mozilla/normandy/pull/641\">#641</a> are ready for review. r?</p>", "id": 219160100, "title": "Stop preference experiments when the server doesn't send them", "pull_request": {"url": "https://api.github.com/repos/mozilla/normandy/pulls/659", "diff_url": "https://github.com/mozilla/normandy/pull/659.diff", "html_url": "https://github.com/mozilla/normandy/pull/659", "patch_url": "https://github.com/mozilla/normandy/pull/659.patch"}, "comments": 8, "state": "closed", "body": "__NOTE:__ This depends on https://github.com/mozilla/normandy/pull/641. I don't expect major changes on that PR so this is probably fine for review, but we should wait for that to land before merging this.\r\n\r\nThis _should_ be the last major refactor for preference experiments. The problem is that we want to stop any experiments that weren't reported by the server or matched to the user, as disabling a recipe simply stops sending it to users. But how do we run logic for preference experiments that don't have action code running? Or, if there's no experiments going out, how do run any action code at all?\r\n\r\nMy answer is to add pre-execution and post-execution hooks that run before any recipes are executed, as well as after all of them are. Each action can register a pre- and post-execution hook. These hooks are executed regardless of whether any recipes were run with the action, which covers stopping the last active experiment. And, if the pre-execution hook fails, we skip recipes and post-execution hooks for the action that failed, to avoid running them with potentially-invalid state.\r\n\r\nSince that meant there were now 3 different types of callables being registered inside the sandbox, it made sense to generalize the pattern. I left the old `registerAction` API in so that we don't immediately have to rewrite our actions. \r\n\r\nThere was also enough logic to prepping the sandbox that I split it into a new `ActionSandboxManager` class, but I kept the `SandboxManager` class as a separate base class. In my head, `SandboxManager` is our general object-oriented wrapper for sandboxes, while `ActionSandboxManager` is where Normandy-specific sandbox prep goes.\r\n\r\nEach commit is pretty standalone, and the shift-click trick for choosing commits to include in the diff will probably come in handy too. I think the bits not from https://github.com/mozilla/normandy/pull/641 are ready for review. r?", "events_url": "https://api.github.com/repos/mozilla/normandy/issues/659/events", "labels_url": "https://api.github.com/repos/mozilla/normandy/issues/659/labels{/name}", "author_association": "MEMBER", "comments_url": "https://api.github.com/repos/mozilla/normandy/issues/659/comments", "html_url": "https://github.com/mozilla/normandy/pull/659", "updated_at": "2017-04-13T21:12:28Z", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "milestone": null, "locked": false, "url": "https://api.github.com/repos/mozilla/normandy/issues/659", "created_at": "2017-04-04T07:14:56Z", "assignees": [{"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}]}