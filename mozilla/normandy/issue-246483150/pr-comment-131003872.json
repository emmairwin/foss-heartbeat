{"original_position": 112, "diff_hunk": "@@ -0,0 +1,133 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\"use strict\";\n+\n+const {utils: Cu} = Components;\n+Cu.import(\"resource://gre/modules/Services.jsm\");\n+Cu.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n+\n+XPCOMUtils.defineLazyModuleGetter(\n+  this, \"AppConstants\", \"resource://gre/modules/AppConstants.jsm\"\n+);\n+XPCOMUtils.defineLazyModuleGetter(\n+  this, \"CleanupManager\", \"resource://shield-recipe-client/lib/CleanupManager.jsm\"\n+);\n+\n+this.EXPORTED_SYMBOLS = [\"ShieldPreferences\"];\n+\n+const XUL_NS = \"http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul\";\n+const NS_PREFBRANCH_PREFCHANGE_TOPIC_ID = \"nsPref:changed\"; // from modules/libpref/nsIPrefBranch.idl\n+const FHR_UPLOAD_ENABLED_PREF = \"datareporting.healthreport.uploadEnabled\";\n+const OPT_OUT_STUDIES_ENABLED_PREF = \"app.shield.optoutstudies.enabled\";\n+\n+/**\n+ * Handles Shield-specific preferences, including their UI.\n+ */\n+this.ShieldPreferences = {\n+  async init() {\n+    // If the FHR pref was disabled since our last run, disable opt-out as well.\n+    if (!Services.prefs.getBoolPref(FHR_UPLOAD_ENABLED_PREF)) {\n+      Services.prefs.setBoolPref(OPT_OUT_STUDIES_ENABLED_PREF, false);\n+    }\n+\n+    // Watch for changes to the FHR pref\n+    Services.prefs.addObserver(FHR_UPLOAD_ENABLED_PREF, this);\n+    CleanupManager.addCleanupHandler(() => {\n+      Services.prefs.removeObserver(FHR_UPLOAD_ENABLED_PREF, this);\n+    });\n+\n+    // Disabled outside of en-* locales temporarily (bug 1377192).\n+    // Disabled when MOZ_DATA_REPORTING is false since the FHR UI is also hidden\n+    // when data reporting is false.\n+    if (AppConstants.MOZ_DATA_REPORTING && Services.locale.getAppLocaleAsLangTag().startsWith(\"en\")) {\n+      Services.obs.addObserver(this, \"advanced-pane-loaded\");\n+      CleanupManager.addCleanupHandler(() => {\n+        Services.obs.removeObserver(this, \"advanced-pane-loaded\");\n+      });\n+    }\n+  },\n+\n+  observe(subject, topic, data) {\n+    switch (topic) {\n+      // Add the opt-out-study checkbox to the Privacy preferences when it is shown.\n+      case \"advanced-pane-loaded\":\n+        if (!Services.prefs.getBoolPref(\"browser.preferences.useOldOrganization\", false)) {\n+          const checkbox = new this.OptOutStudyCheckbox(subject.document);\n+          checkbox.inject();\n+        }\n+        break;\n+      // If the FHR pref changes, set the opt-out-study pref to the value it is changing to.\n+      case NS_PREFBRANCH_PREFCHANGE_TOPIC_ID:\n+        if (data === FHR_UPLOAD_ENABLED_PREF) {\n+          const fhrUploadEnabled = Services.prefs.getBoolPref(FHR_UPLOAD_ENABLED_PREF);\n+          Services.prefs.setBoolPref(OPT_OUT_STUDIES_ENABLED_PREF, fhrUploadEnabled);\n+        }\n+        break;\n+    }\n+  },\n+\n+  /**\n+   * Injects the opt-out-study preference checkbox into about:preferences and\n+   * handles events coming from the UI for it.\n+   */\n+  OptOutStudyCheckbox: class {\n+    constructor(document) {\n+      this.document = document;\n+      this.refs = {};\n+\n+      const container = this.refs.container = document.createElementNS(XUL_NS, \"vbox\");\n+      container.classList.add(\"indent\");\n+\n+      const hContainer = this.refs.hContainer = document.createElementNS(XUL_NS, \"hbox\");\n+      hContainer.setAttribute(\"align\", \"center\");\n+      container.appendChild(hContainer);\n+\n+      const checkbox = this.refs.checkbox = document.createElementNS(XUL_NS, \"checkbox\");\n+      checkbox.setAttribute(\"id\", \"optOutStudiesEnabled\");\n+      checkbox.setAttribute(\"label\", \"Allow Firefox to install and run studies\");\n+      checkbox.setAttribute(\"preference\", OPT_OUT_STUDIES_ENABLED_PREF);\n+      checkbox.setAttribute(\"disabled\", !Services.prefs.getBoolPref(FHR_UPLOAD_ENABLED_PREF));\n+      hContainer.appendChild(checkbox);\n+\n+      const viewStudies = this.refs.viewStudies = document.createElementNS(XUL_NS, \"label\");\n+      viewStudies.setAttribute(\"id\", \"viewShieldStudies\");\n+      viewStudies.setAttribute(\"href\", \"about:studies\");\n+      viewStudies.setAttribute(\"useoriginprincipal\", true);\n+      viewStudies.textContent = \"View Firefox Studies\";\n+      viewStudies.classList.add(\"learnMore\", \"text-link\");\n+      hContainer.appendChild(viewStudies);\n+\n+      // <prefrence> elements for prefs that we need to monitor while the page is open.\n+      const optOutPref = this.refs.optOutPref = document.createElementNS(XUL_NS, \"preference\");\n+      optOutPref.setAttribute(\"id\", OPT_OUT_STUDIES_ENABLED_PREF);\n+      optOutPref.setAttribute(\"name\", OPT_OUT_STUDIES_ENABLED_PREF);\n+      optOutPref.setAttribute(\"type\", \"bool\");\n+\n+      // Weirdly, FHR doesn't have a <preference> element on the page, so we create it.\n+      const fhrPref = this.refs.fhrPref = document.createElementNS(XUL_NS, \"preference\");\n+      fhrPref.setAttribute(\"id\", FHR_UPLOAD_ENABLED_PREF);\n+      fhrPref.setAttribute(\"name\", FHR_UPLOAD_ENABLED_PREF);\n+      fhrPref.setAttribute(\"type\", \"bool\");\n+      fhrPref.addEventListener(\"change\", this);", "body_text": "I'm just a little worried that this object will live longer than it needs, especially since this.refs holds references to all of these elements. Can you inline the event handler here and change OptOutStudyCheckbox to not use this.refs?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/938", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/131003872", "created_at": "2017-08-02T21:38:13Z", "author_association": "NONE", "body": "I'm just a little worried that this object will live longer than it needs, especially since this.refs holds references to all of these elements. Can you inline the event handler here and change OptOutStudyCheckbox to not use this.refs?", "updated_at": "2017-08-08T20:07:34Z", "html_url": "https://github.com/mozilla/normandy/pull/938#discussion_r131003872", "pull_request_review_id": 53938735, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/131003872"}, "html": {"href": "https://github.com/mozilla/normandy/pull/938#discussion_r131003872"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/938"}}, "commit_id": "b057e9026915ddfa6f4ef93147a888f34bb2aba1", "user": {"following_url": "https://api.github.com/users/msujaws/following{/other_user}", "events_url": "https://api.github.com/users/msujaws/events{/privacy}", "organizations_url": "https://api.github.com/users/msujaws/orgs", "url": "https://api.github.com/users/msujaws", "gists_url": "https://api.github.com/users/msujaws/gists{/gist_id}", "html_url": "https://github.com/msujaws", "subscriptions_url": "https://api.github.com/users/msujaws/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/272055?v=4", "repos_url": "https://api.github.com/users/msujaws/repos", "received_events_url": "https://api.github.com/users/msujaws/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/msujaws/starred{/owner}{/repo}", "site_admin": false, "login": "msujaws", "type": "User", "id": 272055, "followers_url": "https://api.github.com/users/msujaws/followers"}, "position": null, "path": "recipe-client-addon/lib/ShieldPreferences.jsm", "body_html": "<p>I'm just a little worried that this object will live longer than it needs, especially since this.refs holds references to all of these elements. Can you inline the event handler here and change OptOutStudyCheckbox to not use this.refs?</p>", "original_commit_id": "c3c63cd7cb5a86af4083051a01021e44f08066d3", "id": 131003872}