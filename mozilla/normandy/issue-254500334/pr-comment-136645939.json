{"original_position": 75, "diff_hunk": "@@ -29,69 +38,146 @@ const DEFAULT_PREFS = {\n   \"app.shield.optoutstudies.enabled\": AppConstants.MOZ_DATA_REPORTING,\n };\n \n-this.install = function() {};\n-\n-this.startup = function() {\n-  // Initialize preference defaults before anything else happens.\n-  const prefBranch = Services.prefs.getDefaultBranch(\"\");\n-  for (const [name, value] of Object.entries(DEFAULT_PREFS)) {\n-    switch (typeof value) {\n-      case \"string\":\n-        prefBranch.setCharPref(name, value);\n-        break;\n-      case \"number\":\n-        prefBranch.setIntPref(name, value);\n-        break;\n-      case \"boolean\":\n-        prefBranch.setBoolPref(name, value);\n-        break;\n-      default:\n-        throw new Error(`Invalid default preference type ${typeof value}`);\n+// Logging\n+const log = Log.repository.getLogger(BOOTSTRAP_LOGGER_NAME);\n+log.addAppender(new Log.ConsoleAppender(new Log.BasicFormatter()));\n+log.level = Services.prefs.getIntPref(PREF_LOGGING_LEVEL, Log.Level.Warn);\n+\n+this.Bootstrap = {\n+  initShieldPrefs(defaultPrefs) {\n+    const prefBranch = Services.prefs.getDefaultBranch(\"\");\n+    for (const [name, value] of Object.entries(defaultPrefs)) {\n+      switch (typeof value) {\n+        case \"string\":\n+          prefBranch.setCharPref(name, value);\n+          break;\n+        case \"number\":\n+          prefBranch.setIntPref(name, value);\n+          break;\n+        case \"boolean\":\n+          prefBranch.setBoolPref(name, value);\n+          break;\n+        default:\n+          throw new Error(`Invalid default preference type ${typeof value}`);\n+      }\n     }\n-  }\n+  },\n \n-  ShieldRecipeClient.startup();\n-};\n+  initExperimentPrefs() {\n+    const defaultBranch = Services.prefs.getDefaultBranch(\"\");\n+    const experimentBranch = Services.prefs.getBranch(STARTUP_EXPERIMENT_PREFS_BRANCH);\n+\n+    for (const childPrefName of experimentBranch.getChildList(\"\")) {\n+      const realPrefName = childPrefName.slice(1); // Remove leading dot\n+      const realPrefType = defaultBranch.getPrefType(childPrefName);\n+      const experimentPrefType = experimentBranch.getPrefType(childPrefName);\n+\n+      // TODO: This never passes?", "body_text": "Ah, ok. I'm not sure it is safe to say that all experiment preferences will have default branches, since some of the experiments are themselves add-ons. But this doesn't explain the PREF_INVALID thing.", "in_reply_to_id": 136475119, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1024", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136645939", "created_at": "2017-09-01T19:07:42Z", "author_association": "MEMBER", "body": "Ah, ok. I'm not sure it is safe to say that all experiment preferences will have default branches, since some of the experiments are themselves add-ons. But this doesn't explain the `PREF_INVALID` thing.", "updated_at": "2017-09-06T17:53:07Z", "html_url": "https://github.com/mozilla/normandy/pull/1024#discussion_r136645939", "pull_request_review_id": 60219447, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136645939"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1024#discussion_r136645939"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1024"}}, "commit_id": "8ee8084c78948533e763ec3b6aab761d3050e8d2", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": null, "path": "recipe-client-addon/bootstrap.js", "body_html": "<p>Ah, ok. I'm not sure it is safe to say that all experiment preferences will have default branches, since some of the experiments are themselves add-ons. But this doesn't explain the <code>PREF_INVALID</code> thing.</p>", "original_commit_id": "58b432cabce9345181a304221ba3b85acd210052", "id": 136645939}