{"original_position": 83, "diff_hunk": "@@ -29,69 +38,146 @@ const DEFAULT_PREFS = {\n   \"app.shield.optoutstudies.enabled\": AppConstants.MOZ_DATA_REPORTING,\n };\n \n-this.install = function() {};\n-\n-this.startup = function() {\n-  // Initialize preference defaults before anything else happens.\n-  const prefBranch = Services.prefs.getDefaultBranch(\"\");\n-  for (const [name, value] of Object.entries(DEFAULT_PREFS)) {\n-    switch (typeof value) {\n-      case \"string\":\n-        prefBranch.setCharPref(name, value);\n-        break;\n-      case \"number\":\n-        prefBranch.setIntPref(name, value);\n-        break;\n-      case \"boolean\":\n-        prefBranch.setBoolPref(name, value);\n-        break;\n-      default:\n-        throw new Error(`Invalid default preference type ${typeof value}`);\n+// Logging\n+const log = Log.repository.getLogger(BOOTSTRAP_LOGGER_NAME);\n+log.addAppender(new Log.ConsoleAppender(new Log.BasicFormatter()));\n+log.level = Services.prefs.getIntPref(PREF_LOGGING_LEVEL, Log.Level.Warn);\n+\n+this.Bootstrap = {\n+  initShieldPrefs(defaultPrefs) {\n+    const prefBranch = Services.prefs.getDefaultBranch(\"\");\n+    for (const [name, value] of Object.entries(defaultPrefs)) {\n+      switch (typeof value) {\n+        case \"string\":\n+          prefBranch.setCharPref(name, value);\n+          break;\n+        case \"number\":\n+          prefBranch.setIntPref(name, value);\n+          break;\n+        case \"boolean\":\n+          prefBranch.setBoolPref(name, value);\n+          break;\n+        default:\n+          throw new Error(`Invalid default preference type ${typeof value}`);\n+      }\n     }\n-  }\n+  },\n \n-  ShieldRecipeClient.startup();\n-};\n+  initExperimentPrefs() {\n+    const defaultBranch = Services.prefs.getDefaultBranch(\"\");\n+    const experimentBranch = Services.prefs.getBranch(STARTUP_EXPERIMENT_PREFS_BRANCH);\n+\n+    for (const childPrefName of experimentBranch.getChildList(\"\")) {\n+      const realPrefName = childPrefName.slice(1); // Remove leading dot\n+      const realPrefType = defaultBranch.getPrefType(childPrefName);\n+      const experimentPrefType = experimentBranch.getPrefType(childPrefName);\n+\n+      // TODO: This never passes?\n+      if (realPrefType !== Services.prefs.PREF_INVALID && realPrefType !== experimentPrefType) {\n+        log.error(`Error setting startup pref ${childPrefName}; pref type does not match.`);\n+        continue;\n+      }\n+\n+      switch (experimentPrefType) {\n+        case Services.prefs.PREF_STRING:\n+          defaultBranch.setCharPref(realPrefName, experimentBranch.getCharPref(childPrefName));", "body_text": "So, this only sets on the default branch. Are we no longer supporting pref experiments on the user branch at all? Do we need to encode that bit into the experiment branch (with \"user.\" or \"default.\" prefixes or something) ?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1024", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136963374", "created_at": "2017-09-05T11:42:39Z", "author_association": "CONTRIBUTOR", "body": "So, this only sets on the default branch. Are we no longer supporting pref experiments on the user branch at all? Do we need to encode that bit into the experiment branch (with \"user.\" or \"default.\" prefixes or something) ?", "updated_at": "2017-09-06T17:53:07Z", "html_url": "https://github.com/mozilla/normandy/pull/1024#discussion_r136963374", "pull_request_review_id": 60565528, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136963374"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1024#discussion_r136963374"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1024"}}, "commit_id": "8ee8084c78948533e763ec3b6aab761d3050e8d2", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": null, "path": "recipe-client-addon/bootstrap.js", "body_html": "<p>So, this only sets on the default branch. Are we no longer supporting pref experiments on the user branch at all? Do we need to encode that bit into the experiment branch (with \"user.\" or \"default.\" prefixes or something) ?</p>", "original_commit_id": "58b432cabce9345181a304221ba3b85acd210052", "id": 136963374}