{"original_position": 45, "diff_hunk": "@@ -5,26 +5,49 @@\n \"use strict\";\n \n const {utils: Cu} = Components;\n+Cu.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n+\n+XPCOMUtils.defineLazyModuleGetter(this, \"AsyncShutdown\", \"resource://gre/modules/AsyncShutdown.jsm\");\n+\n this.EXPORTED_SYMBOLS = [\"CleanupManager\"];\n \n-const cleanupHandlers = new Set();\n+class CleanupManagerClass {\n+  constructor() {\n+    this.handlers = new Set();\n+    this.cleanupPromise = null;\n+  }\n \n-this.CleanupManager = {\n   addCleanupHandler(handler) {\n-    cleanupHandlers.add(handler);\n-  },\n+    this.handlers.add(handler);\n+  }\n \n   removeCleanupHandler(handler) {\n-    cleanupHandlers.delete(handler);\n-  },\n-\n-  cleanup() {\n-    for (const handler of cleanupHandlers) {\n-      try {\n-        handler();\n-      } catch (ex) {\n-        Cu.reportError(ex);\n-      }\n+    this.handlers.delete(handler);\n+  }\n+\n+  async cleanup() {\n+    if (this.cleanupPromise === null) {\n+      this.cleanupPromise = (async () => {\n+        for (const handler of this.handlers) {\n+          try {\n+            await handler();\n+          } catch (ex) {\n+            // TODO: Log error in a way that persists after shutdown", "body_text": "I can't figure out a good way to log an error during shutdown that won't just disappear since the app is closing. Any ideas?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1024", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136475218", "created_at": "2017-08-31T23:58:59Z", "author_association": "MEMBER", "body": "I can't figure out a good way to log an error during shutdown that won't just disappear since the app is closing. Any ideas?", "updated_at": "2017-09-06T17:53:07Z", "html_url": "https://github.com/mozilla/normandy/pull/1024#discussion_r136475218", "pull_request_review_id": 60020650, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136475218"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1024#discussion_r136475218"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1024"}}, "commit_id": "8ee8084c78948533e763ec3b6aab761d3050e8d2", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": null, "path": "recipe-client-addon/lib/CleanupManager.jsm", "body_html": "<p>I can't figure out a good way to log an error during shutdown that won't just disappear since the app is closing. Any ideas?</p>", "original_commit_id": "58b432cabce9345181a304221ba3b85acd210052", "id": 136475218}