{"original_position": 45, "diff_hunk": "@@ -5,26 +5,49 @@\n \"use strict\";\n \n const {utils: Cu} = Components;\n+Cu.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n+\n+XPCOMUtils.defineLazyModuleGetter(this, \"AsyncShutdown\", \"resource://gre/modules/AsyncShutdown.jsm\");\n+\n this.EXPORTED_SYMBOLS = [\"CleanupManager\"];\n \n-const cleanupHandlers = new Set();\n+class CleanupManagerClass {\n+  constructor() {\n+    this.handlers = new Set();\n+    this.cleanupPromise = null;\n+  }\n \n-this.CleanupManager = {\n   addCleanupHandler(handler) {\n-    cleanupHandlers.add(handler);\n-  },\n+    this.handlers.add(handler);\n+  }\n \n   removeCleanupHandler(handler) {\n-    cleanupHandlers.delete(handler);\n-  },\n-\n-  cleanup() {\n-    for (const handler of cleanupHandlers) {\n-      try {\n-        handler();\n-      } catch (ex) {\n-        Cu.reportError(ex);\n-      }\n+    this.handlers.delete(handler);\n+  }\n+\n+  async cleanup() {\n+    if (this.cleanupPromise === null) {\n+      this.cleanupPromise = (async () => {\n+        for (const handler of this.handlers) {\n+          try {\n+            await handler();\n+          } catch (ex) {\n+            // TODO: Log error in a way that persists after shutdown", "body_text": "Yeah, I wouldn't worry too much about this.", "in_reply_to_id": 136475218, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1024", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136958512", "created_at": "2017-09-05T11:16:57Z", "author_association": "CONTRIBUTOR", "body": "Yeah, I wouldn't worry too much about this.", "updated_at": "2017-09-06T17:53:07Z", "html_url": "https://github.com/mozilla/normandy/pull/1024#discussion_r136958512", "pull_request_review_id": 60565528, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136958512"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1024#discussion_r136958512"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1024"}}, "commit_id": "8ee8084c78948533e763ec3b6aab761d3050e8d2", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": null, "path": "recipe-client-addon/lib/CleanupManager.jsm", "body_html": "<p>Yeah, I wouldn't worry too much about this.</p>", "original_commit_id": "58b432cabce9345181a304221ba3b85acd210052", "id": 136958512}