{"original_position": 35, "diff_hunk": "@@ -2,27 +2,44 @@ import uuid from 'node-uuid';\n \n import Mozilla from './uitour.js';\n \n+export const STORAGE_DURABILITY_KEY = '_storageDurability';\n+\n /**\n  * Storage class that uses window.localStorage as it's backing store.\n  */\n-class LocalStorage {\n+export class LocalStorage {\n   /**\n    * @param    {string} prefix Prefix to append to all incoming keys.\n    */\n   constructor(prefix) {\n     this.prefix = prefix;\n   }\n \n+  async isDurable() {\n+    const durabilityStatus = localStorage.getItem(STORAGE_DURABILITY_KEY);\n+    return (parseInt(durabilityStatus, 10) >= 2);\n+  }\n+\n   _makeKey(key) {\n     return `${this.prefix}-${key}`;\n   }\n \n   async getItem(key) {\n-    return localStorage.getItem(this._makeKey(key));\n+    const storageIsDurable = await this.isDurable();\n+    if (!storageIsDurable && !this.testing) {\n+      throw new Error('Storage durability unconfirmed');\n+    }\n+    const val = localStorage.getItem(this._makeKey(key));\n+    try {\n+      return JSON.parse(val);", "body_text": "If you're adding this, you might want to update show-heartbeat implementation to deal with this, and the docs for the storage spec to specify that input and output is JSON-ified during storage. This will be important in the future when storing, say, date objects.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/313", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/86901304", "created_at": "2016-11-08T00:33:12Z", "author_association": "MEMBER", "body": "If you're adding this, you might want to update show-heartbeat implementation to deal with this, and the docs for the storage spec to specify that input and output is JSON-ified during storage. This will be important in the future when storing, say, date objects.\n", "updated_at": "2016-11-09T00:31:42Z", "html_url": "https://github.com/mozilla/normandy/pull/313#discussion_r86901304", "pull_request_review_id": 7535723, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/86901304"}, "html": {"href": "https://github.com/mozilla/normandy/pull/313#discussion_r86901304"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/313"}}, "commit_id": "710bf7efa61187df4a4b9c69222967f3c14b6ed1", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": 37, "path": "client/selfrepair/normandy_driver.js", "body_html": "<p>If you're adding this, you might want to update show-heartbeat implementation to deal with this, and the docs for the storage spec to specify that input and output is JSON-ified during storage. This will be important in the future when storing, say, date objects.</p>", "original_commit_id": "3fce5a3816f9cf45adc0ebeba96fa40459d27a66", "id": 86901304}