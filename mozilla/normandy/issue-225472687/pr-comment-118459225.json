{"original_position": 76, "diff_hunk": "@@ -0,0 +1,78 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+\n+\"use strict\";\n+\n+const {utils: Cu} = Components;\n+Cu.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n+\n+XPCOMUtils.defineLazyModuleGetter(this, \"Services\", \"resource://gre/modules/Services.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"CleanupManager\", \"resource://shield-recipe-client/lib/CleanupManager.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"JSONFile\", \"resource://gre/modules/JSONFile.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"OS\", \"resource://gre/modules/osfile.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"LogManager\", \"resource://shield-recipe-client/lib/LogManager.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"Preferences\", \"resource://gre/modules/Preferences.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"TelemetryEnvironment\", \"resource://gre/modules/TelemetryEnvironment.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"PreferenceManagement\", \"resource://shield-recipe-client/lib/PreferenceManagement.jsm\");\n+\n+this.EXPORTED_SYMBOLS = [\"PreferenceRollout\"];\n+\n+const log = LogManager.getLogger(\"preference-rollouts\");\n+\n+const PREF_NAMESPACE = \"rollouts\";\n+\n+this.PreferenceRollout = Object.assign({}, PreferenceManagement(PREF_NAMESPACE), {\n+  async init() {\n+    this.applyAll();\n+  },\n+\n+  async start({name, preferenceName, preferenceValue, preferenceBranch, preferenceType}) {\n+    log.debug(`PreferenceRollout.enroll(${name} - ${preferenceBranch}/${preferenceName})`);\n+\n+    const hasExistingRollout = await this.has(name);\n+    if (hasExistingRollout) {\n+      throw new Error(`A preference rollout named \"${name}\" already exists.`);\n+    }\n+\n+    /** @type {Experiment} */\n+    const experiment = {\n+      name,\n+      preferenceName,\n+      preferenceValue,\n+      preferenceType,\n+      preferenceBranch,\n+      branch: preferenceBranch,\n+    };\n+\n+    const preferences = this.getPreferenceBranch(preferenceBranch);\n+\n+    // 'User' branch prefs are saved locally, so in the event the user is withdrawn\n+    // from the rollout, the pref can be reset to what the user had originally.\n+    // (Default branch pref rollouts simply unset the value and let the browser\n+    // set its baked-in default value, so we don't need to store it.)\n+    if (preferenceBranch === \"user\") {\n+      const store = await this.getStorage();\n+      store.data[PREF_NAMESPACE][name] = preferences.get(preferenceName);\n+      store.saveSoon();\n+    }\n+\n+    // Validation will throw\n+    this.validateRecipePrefTypes(experiment);\n+\n+    // Save experiment data locally to be read from on startup later\n+    this.saveRecipeData(experiment);\n+    this.startObserver(experiment.name, experiment.preferenceName, experiment.preferenceValue);\n+\n+    // Actually alter the set preference (later, this is done automatically on startup)\n+    preferences.set(preferenceName, preferenceValue);\n+  },\n+\n+  /**\n+   * Stubbed withdraw function\n+   */\n+  async stop(rolloutName, resetValue = true) {\n+    await new Promise(resolve => setTimeout(resolve, 1000));", "body_text": "Uhhh... what is this, why do we need it, why does it have an unused argument, and what's with the setTimeout delay in having resolve() be called? Can we just rm this?", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/724", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/118459225", "created_at": "2017-05-25T10:29:40Z", "author_association": "CONTRIBUTOR", "body": "Uhhh... what is this, why do we need it, why does it have an unused argument, and what's with the setTimeout delay in having resolve() be called? Can we just rm this?", "updated_at": "2017-06-12T21:44:43Z", "html_url": "https://github.com/mozilla/normandy/pull/724#discussion_r118459225", "pull_request_review_id": 40240947, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/118459225"}, "html": {"href": "https://github.com/mozilla/normandy/pull/724#discussion_r118459225"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/724"}}, "commit_id": "46651e36e3771d2c4d90f6529a28ef814e4d9e4b", "user": {"following_url": "https://api.github.com/users/gijsk/following{/other_user}", "events_url": "https://api.github.com/users/gijsk/events{/privacy}", "organizations_url": "https://api.github.com/users/gijsk/orgs", "url": "https://api.github.com/users/gijsk", "gists_url": "https://api.github.com/users/gijsk/gists{/gist_id}", "html_url": "https://github.com/gijsk", "subscriptions_url": "https://api.github.com/users/gijsk/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/375983?v=4", "repos_url": "https://api.github.com/users/gijsk/repos", "received_events_url": "https://api.github.com/users/gijsk/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/gijsk/starred{/owner}{/repo}", "site_admin": false, "login": "gijsk", "type": "User", "id": 375983, "followers_url": "https://api.github.com/users/gijsk/followers"}, "position": null, "path": "recipe-client-addon/lib/PreferenceRollout.jsm", "body_html": "<p>Uhhh... what is this, why do we need it, why does it have an unused argument, and what's with the setTimeout delay in having resolve() be called? Can we just rm this?</p>", "original_commit_id": "56b772323bbfb68cf5f7771579c1c1d213fe33f0", "id": 118459225}