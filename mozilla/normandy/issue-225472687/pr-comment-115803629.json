{"original_position": 64, "diff_hunk": "@@ -0,0 +1,75 @@\n+/* This Source Code Form is subject to the terms of the Mozilla Public\n+ * License, v. 2.0. If a copy of the MPL was not distributed with this\n+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\n+\n+\n+\"use strict\";\n+\n+const {utils: Cu} = Components;\n+Cu.import(\"resource://gre/modules/XPCOMUtils.jsm\");\n+\n+XPCOMUtils.defineLazyModuleGetter(this, \"Services\", \"resource://gre/modules/Services.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"CleanupManager\", \"resource://shield-recipe-client/lib/CleanupManager.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"JSONFile\", \"resource://gre/modules/JSONFile.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"OS\", \"resource://gre/modules/osfile.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"LogManager\", \"resource://shield-recipe-client/lib/LogManager.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"Preferences\", \"resource://gre/modules/Preferences.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"TelemetryEnvironment\", \"resource://gre/modules/TelemetryEnvironment.jsm\");\n+XPCOMUtils.defineLazyModuleGetter(this, \"PreferenceManagement\", \"resource://shield-recipe-client/lib/PreferenceManagement.jsm\");\n+\n+this.EXPORTED_SYMBOLS = [\"PreferenceRollout\"];\n+\n+const Manager = PreferenceManagement(\"rollouts\");\n+const log = LogManager.getLogger(\"preference-rollouts\");\n+\n+this.PreferenceRollout = {\n+  async init() {\n+    Manager.applyAll();\n+  },\n+\n+  async start({name, preferenceName, preferenceValue, preferenceBranch, preferenceType}) {\n+    log.debug(`PreferenceRollout.enroll(${name} - ${preferenceBranch}/${preferenceName})`);\n+\n+    const hasExistingRollout = await Manager.has(name);\n+    if (hasExistingRollout) {\n+      throw new Error(`A preference rollout named \"${name}\" already exists.`);\n+    }\n+\n+    /** @type {Experiment} */\n+    const experiment = {\n+      name,\n+      preferenceName,\n+      preferenceValue,\n+      preferenceType,\n+      preferenceBranch,\n+      branch: preferenceBranch,\n+    };\n+\n+    // 'User' branch prefs are saved locally, so in the event the user is withdrawn\n+    // from the rollout, the pref can be reset to what the user had originally.\n+    // (Default branch pref rollouts simply unset the value and let the browser\n+    // set its baked-in default value, so we don't need to store it.)\n+    // if (preferenceBranch === \"user\") {\n+      // store.data[name] = prevValue;\n+      // store.saveSoon();\n+    // }\n+\n+    // Validation will throw\n+    Manager.validateRecipe(experiment);\n+\n+    // Save experiment data locally to be read from on startup later\n+    Manager.saveRecipeData(experiment);\n+    Manager.startObserver(experiment.name, experiment.preferenceName, experiment.preferenceValue);\n+\n+    // Actually alter the set preference (this is done automatically on startup)", "body_text": "Can you explain this comment a bit more? I'm not sure what \"this is done automatically on startup\" is referring to.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/724", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/115803629", "created_at": "2017-05-10T17:34:16Z", "author_association": "MEMBER", "body": "Can you explain this comment a bit more? I'm not sure what \"this is done automatically on startup\" is referring to.", "updated_at": "2017-06-12T21:44:43Z", "html_url": "https://github.com/mozilla/normandy/pull/724#discussion_r115803629", "pull_request_review_id": 37374767, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/115803629"}, "html": {"href": "https://github.com/mozilla/normandy/pull/724#discussion_r115803629"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/724"}}, "commit_id": "46651e36e3771d2c4d90f6529a28ef814e4d9e4b", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": null, "path": "recipe-client-addon/lib/PreferenceRollout.jsm", "body_html": "<p>Can you explain this comment a bit more? I'm not sure what \"this is done automatically on startup\" is referring to.</p>", "original_commit_id": "4d11c30309ecd846b504410099dc5f71278c5cbf", "id": 115803629}