{"original_position": 54, "diff_hunk": "@@ -0,0 +1,68 @@\n+# -*- coding: utf-8 -*-\n+# Generated by Django 1.9.11 on 2016-11-28 13:48\n+# flake8: noqa\n+from __future__ import unicode_literals\n+\n+import hashlib\n+import json\n+\n+from django.db import migrations\n+\n+\n+def hash_revision_data(revision):\n+    data = '{}{}{}{}{}{}'.format(revision.recipe.id, revision.created, revision.name,\n+                                 revision.action.id, revision.arguments_json,\n+                                 revision.filter_expression)\n+    return hashlib.sha256(data.encode()).hexdigest()\n+\n+\n+def migrate_reversion_data(apps, schema_editor):\n+    Action = apps.get_model('recipes', 'Action')\n+    Recipe = apps.get_model('recipes', 'Recipe')\n+    RecipeRevision = apps.get_model('recipes', 'RecipeRevision')\n+    Version = apps.get_model('reversion', 'Version')\n+    ContentType = apps.get_model('contenttypes', 'ContentType')\n+\n+    try:\n+        ct = ContentType.objects.get(app_label='recipes', model='recipe')\n+    except ContentType.DoesNotExist:\n+        # There are no content types so there is no data to be migrated\n+        pass\n+    else:\n+        for r in Recipe.objects.all():\n+            revision = None\n+\n+            for v in Version.objects.filter(content_type=ct, object_id=r.id).order_by(\n+                    'revision__date_created'):\n+\n+                v = Version.objects.get(revision_id=v.revision.id)\n+\n+                data = json.loads(v.serialized_data)[0]['fields']\n+\n+                action = Action.objects.get(id=data.get('action'))\n+\n+                revision = RecipeRevision(\n+                    recipe=r, parent=revision, created=v.revision.date_created,\n+                    comment=v.revision.comment, user=v.revision.user, name=data.get('name'),\n+                    action=action, arguments_json=data.get('arguments_json', ''),\n+                    filter_expression=data.get('filter_expression', ''))\n+\n+                revision.id = hash_revision_data(revision)\n+\n+                revision.save()\n+\n+            r.latest_revision = revision", "body_text": "It should be creating a reversion when the recipe is created. So that's not it. I'll add the assert.", "in_reply_to_id": 95450544, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/410", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/95497334", "created_at": "2017-01-11T01:41:22Z", "author_association": "MEMBER", "body": "It should be creating a reversion when the recipe is created. So that's not it. I'll add the `assert`.", "updated_at": "2017-01-13T22:13:08Z", "html_url": "https://github.com/mozilla/normandy/pull/410#discussion_r95497334", "pull_request_review_id": 16053608, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/95497334"}, "html": {"href": "https://github.com/mozilla/normandy/pull/410#discussion_r95497334"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/410"}}, "commit_id": "c80dbf01212e9ece69fb8c06c7def0ffc84bb898", "user": {"following_url": "https://api.github.com/users/rehandalal/following{/other_user}", "events_url": "https://api.github.com/users/rehandalal/events{/privacy}", "organizations_url": "https://api.github.com/users/rehandalal/orgs", "url": "https://api.github.com/users/rehandalal", "gists_url": "https://api.github.com/users/rehandalal/gists{/gist_id}", "html_url": "https://github.com/rehandalal", "subscriptions_url": "https://api.github.com/users/rehandalal/subscriptions", "avatar_url": "https://avatars2.githubusercontent.com/u/987136?v=4", "repos_url": "https://api.github.com/users/rehandalal/repos", "received_events_url": "https://api.github.com/users/rehandalal/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/rehandalal/starred{/owner}{/repo}", "site_admin": false, "login": "rehandalal", "type": "User", "id": 987136, "followers_url": "https://api.github.com/users/rehandalal/followers"}, "position": null, "path": "normandy/recipes/migrations/0035_revision_data.py", "body_html": "<p>It should be creating a reversion when the recipe is created. So that's not it. I'll add the <code>assert</code>.</p>", "original_commit_id": "2e8afa412698793b98b276b8d1b1b8c11eeadcca", "id": 95497334}