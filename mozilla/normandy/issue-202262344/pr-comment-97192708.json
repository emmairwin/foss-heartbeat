{"original_position": 10, "diff_hunk": "@@ -0,0 +1,50 @@\n+\"use strict\";\n+\n+const {utils: Cu} = Components;\n+Cu.import(\"resource://shield-recipe-client/lib/NormandyDriver.jsm\", this);\n+Cu.import(\"resource://shield-recipe-client/lib/SandboxManager.jsm\", this);\n+\n+const UUID_REGEX = /[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/;\n+\n+add_task(function* uuids() {\n+  const sandboxManager = new SandboxManager();", "body_text": "I found a neat pattern in some other tests that may help reduce some repeated typing:\nlet mockPluginCID;\nadd_task(function* setup() {\n  mockPluginCID = MockRegistrar.register(\"@mozilla.org/plugin/host;1\", gPluginHost);\n  registerCleanupFunction(() => {\n    MockRegistrar.unregister(mockPluginCID);\n  });\n});\nYou could do the same for this driver init. registerCleanupFunction is a mochitest thing, but xpcshell tests have do_register_cleanup.\nI think it doesn't have any issues with leaks. But I'm still pretty new to thinking about leaks in JS so that might be a lie.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/441", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/97192708", "created_at": "2017-01-21T06:59:05Z", "author_association": "MEMBER", "body": "I found a neat pattern in some other tests that may help reduce some repeated typing:\r\n\r\n```js\r\nlet mockPluginCID;\r\nadd_task(function* setup() {\r\n  mockPluginCID = MockRegistrar.register(\"@mozilla.org/plugin/host;1\", gPluginHost);\r\n  registerCleanupFunction(() => {\r\n    MockRegistrar.unregister(mockPluginCID);\r\n  });\r\n});\r\n```\r\n\r\nYou could do the same for this driver init. `registerCleanupFunction` is a mochitest thing, but xpcshell tests have [`do_register_cleanup`](https://developer.mozilla.org/en-US/docs/Mozilla/QA/Writing_xpcshell-based_unit_tests#Test_case_registration_and_execution).\r\n\r\nI _think_ it doesn't have any issues with leaks. But I'm still pretty new to thinking about leaks in JS so that might be a lie.", "updated_at": "2017-01-25T18:37:30Z", "html_url": "https://github.com/mozilla/normandy/pull/441#discussion_r97192708", "pull_request_review_id": 17801384, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/97192708"}, "html": {"href": "https://github.com/mozilla/normandy/pull/441#discussion_r97192708"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/441"}}, "commit_id": "910227d94b0b381ab52a5e9ddb6c672d9bf7f9a1", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": null, "path": "recipe-client-addon/test/browser/browser_NormandyDriver.js", "body_html": "<p>I found a neat pattern in some other tests that may help reduce some repeated typing:</p>\n<div class=\"highlight highlight-source-js\"><pre><span class=\"pl-k\">let</span> mockPluginCID;\n<span class=\"pl-en\">add_task</span>(<span class=\"pl-k\">function</span><span class=\"pl-k\">*</span> <span class=\"pl-en\">setup</span>() {\n  mockPluginCID <span class=\"pl-k\">=</span> <span class=\"pl-smi\">MockRegistrar</span>.<span class=\"pl-en\">register</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>@mozilla.org/plugin/host;1<span class=\"pl-pds\">\"</span></span>, gPluginHost);\n  <span class=\"pl-en\">registerCleanupFunction</span>(() <span class=\"pl-k\">=&gt;</span> {\n    <span class=\"pl-smi\">MockRegistrar</span>.<span class=\"pl-en\">unregister</span>(mockPluginCID);\n  });\n});</pre></div>\n<p>You could do the same for this driver init. <code>registerCleanupFunction</code> is a mochitest thing, but xpcshell tests have <a href=\"https://developer.mozilla.org/en-US/docs/Mozilla/QA/Writing_xpcshell-based_unit_tests#Test_case_registration_and_execution\" rel=\"nofollow\"><code>do_register_cleanup</code></a>.</p>\n<p>I <em>think</em> it doesn't have any issues with leaks. But I'm still pretty new to thinking about leaks in JS so that might be a lie.</p>", "original_commit_id": "8a4301c4e749e80a3646a5abedbadc0abafde08e", "id": 97192708}