{"original_position": 82, "diff_hunk": "@@ -33,33 +38,53 @@ XPCOMUtils.defineLazyGetter(this, \"jexl\", () => {\n   return jexl;\n });\n \n-const getLatestTelemetry = Task.async(function *() {\n-  const pings = yield TelemetryArchive.promiseArchivedPingList();\n+this.EnvExpressions = {\n+  getLatestTelemetry: Task.async(function *() {\n+    const pings = yield TelemetryArchive.promiseArchivedPingList();\n \n-  // get most recent ping per type\n-  const mostRecentPings = {};\n-  for (const ping of pings) {\n-    if (ping.type in mostRecentPings) {\n-      if (mostRecentPings[ping.type].timeStampCreated < ping.timeStampCreated) {\n+    // get most recent ping per type\n+    const mostRecentPings = {};\n+    for (const ping of pings) {\n+      if (ping.type in mostRecentPings) {\n+        if (mostRecentPings[ping.type].timeStampCreated < ping.timeStampCreated) {\n+          mostRecentPings[ping.type] = ping;\n+        }\n+      } else {\n         mostRecentPings[ping.type] = ping;\n       }\n-    } else {\n-      mostRecentPings[ping.type] = ping;\n     }\n-  }\n \n-  const telemetry = {};\n-  for (const key in mostRecentPings) {\n-    const ping = mostRecentPings[key];\n-    telemetry[ping.type] = yield TelemetryArchive.promiseArchivedPingById(ping.id);\n-  }\n-  return telemetry;\n-});\n+    const telemetry = {};\n+    for (const key in mostRecentPings) {\n+      const ping = mostRecentPings[key];\n+      telemetry[ping.type] = yield TelemetryArchive.promiseArchivedPingById(ping.id);\n+    }\n+    return telemetry;\n+  }),\n+\n+  getUserId() {\n+    let id = prefs.getCharPref(\"user_id\");\n+    console.log(\"pref user_id\", id);\n+    if (id === \"\") {\n+      id = generateUUID().toString().slice(1, -1);\n+      prefs.setCharPref(\"user_id\", id);\n+    }\n+    console.log(\"getUserId ret\", id);\n+    return id;\n+  },\n \n-this.EnvExpressions = {\n   eval(expr, extraContext = {}) {\n-    const context = Object.assign({telemetry: getLatestTelemetry()}, extraContext);\n+    // First clone the extra context\n+    const context = Object.assign({}, extraContext);\n+    // jexl handles promises, so it is fine to include them in this data.\n+    context.telemetry = EnvExpressions.getLatestTelemetry();\n+    context.normandy = context.normandy || {};", "body_text": "None of the current EnvExpression tests provide context.normandy, and so are only using the fallback. I'll add a test for the non-fallback case.", "in_reply_to_id": 97192741, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/441", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/97388442", "created_at": "2017-01-23T18:52:20Z", "author_association": "MEMBER", "body": "None of the current EnvExpression tests provide context.normandy, and so are only using the fallback. I'll add a test for the non-fallback case.", "updated_at": "2017-01-25T18:37:30Z", "html_url": "https://github.com/mozilla/normandy/pull/441#discussion_r97388442", "pull_request_review_id": 17996140, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/97388442"}, "html": {"href": "https://github.com/mozilla/normandy/pull/441#discussion_r97388442"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/441"}}, "commit_id": "910227d94b0b381ab52a5e9ddb6c672d9bf7f9a1", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": 83, "path": "recipe-client-addon/lib/EnvExpressions.jsm", "body_html": "<p>None of the current EnvExpression tests provide context.normandy, and so are only using the fallback. I'll add a test for the non-fallback case.</p>", "original_commit_id": "8a4301c4e749e80a3646a5abedbadc0abafde08e", "id": 97388442}