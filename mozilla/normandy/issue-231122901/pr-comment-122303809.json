{"original_position": 17, "diff_hunk": "@@ -12,6 +12,48 @@ add_task(withDriver(Assert, async function uuids(driver) {\n   isnot(uuid1, uuid2, \"uuids are unique\");\n }));\n \n+add_task(withDriver(Assert, async function installXpi(driver) {\n+  // Test that we can install an XPI from any URL\n+  const dir = getChromeDir(getResolvedURI(gTestPath));\n+  dir.append(\"fixtures\");\n+  dir.append(\"normandy.xpi\");\n+  const xpiUrl = Services.io.newFileURI(dir).spec;\n+  var addonId = await driver.installAddon(xpiUrl);\n+  is(addonId, \"normandydriver@example.com\", \"Expected test addon was installed\");\n+  isnot(addonId, null, \"Addon install was successful\");\n+\n+  // Installing kicks off an asychronous process which tries to read the manifest.json\n+  // to startup the addon. Note that onInstallEnded is triggered too early\n+  // which is why we need this delay.\n+  await new Promise(resolve => SimpleTest.executeSoon(resolve));", "body_text": "I think this is really a problem with extensions/internal/XPIInstall.jsm and the way that checkPrompot fires off an async function right away.    Using the observer doesn't work right now because the onInstallEnded listeners are triggered prior to the install actually finishing up.", "in_reply_to_id": 122076039, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/778", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/122303809", "created_at": "2017-06-15T20:25:32Z", "author_association": "CONTRIBUTOR", "body": "I think this is really a problem with `extensions/internal/XPIInstall.jsm` and the way that checkPrompot fires off an async function right away.    Using the observer doesn't work right now because the `onInstallEnded` listeners are triggered prior to the install actually finishing up. ", "updated_at": "2017-06-15T20:25:32Z", "html_url": "https://github.com/mozilla/normandy/pull/778#discussion_r122303809", "pull_request_review_id": 44409024, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/122303809"}, "html": {"href": "https://github.com/mozilla/normandy/pull/778#discussion_r122303809"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/778"}}, "commit_id": "dbb2b5aba2dd9803c76a77a0dae01a837d9bd9fe", "user": {"following_url": "https://api.github.com/users/crankycoder/following{/other_user}", "events_url": "https://api.github.com/users/crankycoder/events{/privacy}", "organizations_url": "https://api.github.com/users/crankycoder/orgs", "url": "https://api.github.com/users/crankycoder", "gists_url": "https://api.github.com/users/crankycoder/gists{/gist_id}", "html_url": "https://github.com/crankycoder", "subscriptions_url": "https://api.github.com/users/crankycoder/subscriptions", "avatar_url": "https://avatars2.githubusercontent.com/u/4829?v=4", "repos_url": "https://api.github.com/users/crankycoder/repos", "received_events_url": "https://api.github.com/users/crankycoder/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/crankycoder/starred{/owner}{/repo}", "site_admin": false, "login": "crankycoder", "type": "User", "id": 4829, "followers_url": "https://api.github.com/users/crankycoder/followers"}, "position": 17, "path": "recipe-client-addon/test/browser/browser_NormandyDriver.js", "body_html": "<p>I think this is really a problem with <code>extensions/internal/XPIInstall.jsm</code> and the way that checkPrompot fires off an async function right away.    Using the observer doesn't work right now because the <code>onInstallEnded</code> listeners are triggered prior to the install actually finishing up.</p>", "original_commit_id": "86326dfb8d17e7997d98aeaa9b2869634746dfaf", "id": 122303809}