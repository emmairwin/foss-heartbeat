{"original_position": 48, "diff_hunk": "@@ -91,3 +99,32 @@ class NormandyCommonMiddleware(CommonMiddleware):\n     \"\"\"\n \n     response_redirect_class = HttpResponsePermanentRedirectCached\n+\n+\n+class NormandySecurityMiddleware(SecurityMiddleware):\n+    \"\"\"Logs HTTP to HTTPS redirects, and adds cache headers to them.\"\"\"\n+\n+    def process_request(self, request):\n+        response = super().process_request(request)\n+        if response is not None:\n+            assert type(response) is http.HttpResponsePermanentRedirect\n+            patch_cache_control(response, public=True, max_age=settings.PERMANENT_REDIRECT_CACHE_TIME)\n+\n+            # Pull out just the HTTP headers from the rest of the request meta\n+            headers = {\n+                key.lstrip('HTTP_'): value\n+                for (key, value) in request.META.items()\n+                if key.startswith('HTTP_') or key == 'CONTENT_TYPE' or key == 'CONTENT_LENGTH'\n+            }\n+\n+            logger.debug(", "body_text": "You're right, this can collect personally-identifiable information. This is here specifically because @relud asked for \"absolutely everything you can get, especially body and headers\".\nAlso, our logs are already considered sensitive information. Some information gets scrubbed out before it gets put in something like parquet.\n@relud does that sound correct?", "in_reply_to_id": 136482664, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1018", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136622631", "created_at": "2017-09-01T17:08:21Z", "author_association": "MEMBER", "body": "You're right, this can collect personally-identifiable information. This is here specifically because @relud asked for \"absolutely everything you can get, especially body and headers\".\r\n\r\nAlso, our logs are already considered sensitive information. Some information gets scrubbed out before it gets put in something like parquet.\r\n\r\n@relud does that sound correct?", "updated_at": "2017-09-05T17:32:30Z", "html_url": "https://github.com/mozilla/normandy/pull/1018#discussion_r136622631", "pull_request_review_id": 60192116, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136622631"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1018#discussion_r136622631"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1018"}}, "commit_id": "ca30201f35fc50f388c2e074c2aee47080183741", "user": {"following_url": "https://api.github.com/users/mythmon/following{/other_user}", "events_url": "https://api.github.com/users/mythmon/events{/privacy}", "organizations_url": "https://api.github.com/users/mythmon/orgs", "url": "https://api.github.com/users/mythmon", "gists_url": "https://api.github.com/users/mythmon/gists{/gist_id}", "html_url": "https://github.com/mythmon", "subscriptions_url": "https://api.github.com/users/mythmon/subscriptions", "avatar_url": "https://avatars3.githubusercontent.com/u/305049?v=4", "repos_url": "https://api.github.com/users/mythmon/repos", "received_events_url": "https://api.github.com/users/mythmon/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/mythmon/starred{/owner}{/repo}", "site_admin": false, "login": "mythmon", "type": "User", "id": 305049, "followers_url": "https://api.github.com/users/mythmon/followers"}, "position": 48, "path": "recipe-server/normandy/base/middleware.py", "body_html": "<p>You're right, this can collect personally-identifiable information. This is here specifically because <a class=\"user-mention\" href=\"https://github.com/relud\">@relud</a> asked for \"absolutely everything you can get, especially body and headers\".</p>\n<p>Also, our logs are already considered sensitive information. Some information gets scrubbed out before it gets put in something like parquet.</p>\n<p><a class=\"user-mention\" href=\"https://github.com/relud\">@relud</a> does that sound correct?</p>", "original_commit_id": "6977e02a07d9793455b3c6f3e6339587deb02d59", "id": 136622631}