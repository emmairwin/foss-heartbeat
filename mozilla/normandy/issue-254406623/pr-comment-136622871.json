{"original_position": 48, "diff_hunk": "@@ -91,3 +99,32 @@ class NormandyCommonMiddleware(CommonMiddleware):\n     \"\"\"\n \n     response_redirect_class = HttpResponsePermanentRedirectCached\n+\n+\n+class NormandySecurityMiddleware(SecurityMiddleware):\n+    \"\"\"Logs HTTP to HTTPS redirects, and adds cache headers to them.\"\"\"\n+\n+    def process_request(self, request):\n+        response = super().process_request(request)\n+        if response is not None:\n+            assert type(response) is http.HttpResponsePermanentRedirect\n+            patch_cache_control(response, public=True, max_age=settings.PERMANENT_REDIRECT_CACHE_TIME)\n+\n+            # Pull out just the HTTP headers from the rest of the request meta\n+            headers = {\n+                key.lstrip('HTTP_'): value\n+                for (key, value) in request.META.items()\n+                if key.startswith('HTTP_') or key == 'CONTENT_TYPE' or key == 'CONTENT_LENGTH'\n+            }\n+\n+            logger.debug(", "body_text": "yes. also in prod you aren't supposed to be able to hit this page.", "in_reply_to_id": 136482664, "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1018", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136622871", "created_at": "2017-09-01T17:09:31Z", "author_association": "CONTRIBUTOR", "body": "yes. also in prod you aren't supposed to be able to hit this page.", "updated_at": "2017-09-05T17:32:30Z", "html_url": "https://github.com/mozilla/normandy/pull/1018#discussion_r136622871", "pull_request_review_id": 60192387, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136622871"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1018#discussion_r136622871"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1018"}}, "commit_id": "ca30201f35fc50f388c2e074c2aee47080183741", "user": {"following_url": "https://api.github.com/users/relud/following{/other_user}", "events_url": "https://api.github.com/users/relud/events{/privacy}", "organizations_url": "https://api.github.com/users/relud/orgs", "url": "https://api.github.com/users/relud", "gists_url": "https://api.github.com/users/relud/gists{/gist_id}", "html_url": "https://github.com/relud", "subscriptions_url": "https://api.github.com/users/relud/subscriptions", "avatar_url": "https://avatars0.githubusercontent.com/u/433717?v=4", "repos_url": "https://api.github.com/users/relud/repos", "received_events_url": "https://api.github.com/users/relud/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/relud/starred{/owner}{/repo}", "site_admin": false, "login": "relud", "type": "User", "id": 433717, "followers_url": "https://api.github.com/users/relud/followers"}, "position": 48, "path": "recipe-server/normandy/base/middleware.py", "body_html": "<p>yes. also in prod you aren't supposed to be able to hit this page.</p>", "original_commit_id": "6977e02a07d9793455b3c6f3e6339587deb02d59", "id": 136622871}