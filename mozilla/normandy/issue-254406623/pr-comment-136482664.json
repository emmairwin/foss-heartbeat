{"original_position": 48, "diff_hunk": "@@ -91,3 +99,32 @@ class NormandyCommonMiddleware(CommonMiddleware):\n     \"\"\"\n \n     response_redirect_class = HttpResponsePermanentRedirectCached\n+\n+\n+class NormandySecurityMiddleware(SecurityMiddleware):\n+    \"\"\"Logs HTTP to HTTPS redirects, and adds cache headers to them.\"\"\"\n+\n+    def process_request(self, request):\n+        response = super().process_request(request)\n+        if response is not None:\n+            assert type(response) is http.HttpResponsePermanentRedirect\n+            patch_cache_control(response, public=True, max_age=settings.PERMANENT_REDIRECT_CACHE_TIME)\n+\n+            # Pull out just the HTTP headers from the rest of the request meta\n+            headers = {\n+                key.lstrip('HTTP_'): value\n+                for (key, value) in request.META.items()\n+                if key.startswith('HTTP_') or key == 'CONTENT_TYPE' or key == 'CONTENT_LENGTH'\n+            }\n+\n+            logger.debug(", "body_text": "Could this collect any personally-identifiable or otherwise sensitive info? CSRF tokens? Auth0 information? I think generally we should avoid storing that kind of data in the logs when possible (although we may already be storing that info in the logs and I'm just not aware or wrong that it's a potential issue).\nPerhaps we should consider a whitelist of headers to collect, and no request body data.", "pull_request_url": "https://api.github.com/repos/mozilla/normandy/pulls/1018", "url": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136482664", "created_at": "2017-09-01T01:20:20Z", "author_association": "MEMBER", "body": "Could this collect any personally-identifiable or otherwise sensitive info? CSRF tokens? Auth0 information? I think generally we should avoid storing that kind of data in the logs when possible (although we may already be storing that info in the logs and I'm just not aware or wrong that it's a potential issue).\r\n\r\nPerhaps we should consider a whitelist of headers to collect, and no request body data.", "updated_at": "2017-09-05T17:32:30Z", "html_url": "https://github.com/mozilla/normandy/pull/1018#discussion_r136482664", "pull_request_review_id": 60029016, "_links": {"self": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/comments/136482664"}, "html": {"href": "https://github.com/mozilla/normandy/pull/1018#discussion_r136482664"}, "pull_request": {"href": "https://api.github.com/repos/mozilla/normandy/pulls/1018"}}, "commit_id": "ca30201f35fc50f388c2e074c2aee47080183741", "user": {"following_url": "https://api.github.com/users/Osmose/following{/other_user}", "events_url": "https://api.github.com/users/Osmose/events{/privacy}", "organizations_url": "https://api.github.com/users/Osmose/orgs", "url": "https://api.github.com/users/Osmose", "gists_url": "https://api.github.com/users/Osmose/gists{/gist_id}", "html_url": "https://github.com/Osmose", "subscriptions_url": "https://api.github.com/users/Osmose/subscriptions", "avatar_url": "https://avatars1.githubusercontent.com/u/193106?v=4", "repos_url": "https://api.github.com/users/Osmose/repos", "received_events_url": "https://api.github.com/users/Osmose/received_events", "gravatar_id": "", "starred_url": "https://api.github.com/users/Osmose/starred{/owner}{/repo}", "site_admin": false, "login": "Osmose", "type": "User", "id": 193106, "followers_url": "https://api.github.com/users/Osmose/followers"}, "position": 48, "path": "recipe-server/normandy/base/middleware.py", "body_html": "<p>Could this collect any personally-identifiable or otherwise sensitive info? CSRF tokens? Auth0 information? I think generally we should avoid storing that kind of data in the logs when possible (although we may already be storing that info in the logs and I'm just not aware or wrong that it's a potential issue).</p>\n<p>Perhaps we should consider a whitelist of headers to collect, and no request body data.</p>", "original_commit_id": "6977e02a07d9793455b3c6f3e6339587deb02d59", "id": 136482664}